<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¨æ–¹ä½ä¿éšªéœ€æ±‚æ¬Šé‡åˆ†æ</title>

<style>
/* =========================================
   ğŸ¨ è¦–è¦ºè¨­è¨ˆç³»çµ±
   ========================================= */
:root { 
    --primary: #2c3e50; 
    --accent: #c0392b; 
    --selected: #27ae60; 
    --bg: #f8f9fa; 
    --card: #ffffff; 
    --text: #333; 
}
body { 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
    background: var(--bg); margin: 0; padding: 20px; 
    display: flex; justify-content: center; align-items: center; min-height: 100vh; flex-direction: column;
}
.container { 
    background: var(--card); max-width: 620px; width: 100%; 
    padding: 30px; border-radius: 12px; 
    box-shadow: 0 10px 25px rgba(0,0,0,0.08); position: relative; 
}
h2, h3, h4 { text-align: center; color: var(--primary); }
p { text-align: center; color: #666; line-height: 1.6; }

.progress-bar { height: 6px; background: #eee; border-radius: 3px; margin-bottom: 20px; overflow: hidden; }
.progress-fill { height: 100%; background: var(--accent); width: 0%; transition: .3s; }

/* è¼¸å…¥æ¡†èˆ‡é¸å–® */
input[type=text], input[type=tel], select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; transition: 0.3s; background: #fff; }
input:focus, select:focus { border-color: var(--primary); outline: none; }
input[readonly] { cursor: pointer; background-color: #fff; caret-color: transparent; }

.radio-group { display: flex; gap: 10px; margin-bottom: 15px; }
.radio-label { flex: 1; border: 1px solid #ddd; border-radius: 6px; padding: 10px; display: flex; align-items: center; gap: 6px; cursor: pointer; transition: 0.2s; }
.radio-label:hover { background: #f1f1f1; }

/* é¸é …å¡ç‰‡ (æ¨™æº–æ¨¡å¼) */
.option-pool { display: flex; flex-direction: column; gap: 12px; }
.option-card { border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; cursor: pointer; display: flex; align-items: center; transition: .2s; background: #fff; position: relative; }
.option-card:active { transform: scale(0.98); }
.option-card.selected { border-color: var(--selected); background: #f0fff4; }
.rank-box { width: 32px; height: 32px; border-radius: 6px; border: 2px solid #ccc; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; background: #fff; transition: .2s; }
.option-card.selected .rank-box { background: var(--selected); color: #fff; border-color: var(--selected); }

/* ğŸ”¥ V19.0 äºŒé¸ä¸€ PK å¡ç‰‡ (å°ˆç”¨æ¨£å¼) */
.pk-container { display: flex; gap: 10px; margin-top: 10px; height: 160px; }
.pk-card { flex: 1; border: 2px solid #ddd; border-radius: 12px; padding: 15px 10px; text-align: center; cursor: pointer; transition: 0.2s; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; }
.pk-card:hover { border-color: var(--primary); background: #fdfdfd; }
.pk-card:active { transform: scale(0.96); border-color: var(--accent); }
.pk-title { font-weight: bold; font-size: 1.1em; color: var(--text); line-height: 1.4; }
.pk-desc { font-size: 0.85em; color: #777; margin-top: 8px; }
/* VS åœ–ç¤º */
.pk-vs { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); background: var(--accent); color: #fff; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8em; border: 3px solid #fff; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

/* æŒ‰éˆ• */
.nav-btn { width: 100%; padding: 14px; border: none; border-radius: 6px; font-size: 16px; margin-top: 20px; background: #aaa; color: #fff; opacity: .5; pointer-events: none; transition: .3s; cursor: not-allowed; }
.nav-btn.ready { background: var(--accent); opacity: 1; pointer-events: auto; cursor: pointer; box-shadow: 0 4px 10px rgba(192, 57, 43, 0.3); }

.step { display: none; animation: fadeIn 0.4s; }
.step.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* ç¢ºèªæŒ‰éˆ• */
.check-btn-group { display: flex; gap: 15px; margin-top: 20px; }
.check-btn { flex: 1; padding: 15px; border-radius: 8px; border: 2px solid #ddd; background: #fff; font-weight: bold; cursor: pointer; }
.check-btn.yes { border-color: var(--selected); color: var(--selected); }
.check-btn.no { border-color: var(--accent); color: var(--accent); }

/* çµæœé  */
.result-card { border-radius: 10px; padding: 25px; margin-top: 20px; text-align: left; color: #333; border-left: 6px solid #ccc; background: #f9f9f9; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
.result-type-1 { border-left-color: #3498db; background: #eaf6ff; } 
.result-type-2 { border-left-color: #95a5a6; background: #f4f6f7; } 
.result-type-3 { border-left-color: #f1c40f; background: #fffbe6; } 
.result-type-4 { border-left-color: #8e44ad; background: #f3e5f5; }

.result-title { font-size: 1.5em; font-weight: bold; margin-bottom: 12px; display: block; }
.result-desc { font-size: 1em; line-height: 1.6; color: #444; }
.tag-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; margin-right: 5px; margin-bottom: 5px; color: white; }
.bg-blue { background: #3498db; }
.bg-green { background: #27ae60; }
.bg-purple { background: #8e44ad; }
.bg-orange { background: #f39c12; }

.strategy-box { border-top: 1px dashed #ccc; margin-top: 20px; padding-top: 15px; font-size: 0.95em; color: #555; background: rgba(255,255,255,0.5); padding: 15px; border-radius: 8px; }
.disclaimer { font-size: 0.8em; color: #999; margin-top: 30px; border-top: 1px solid #eee; padding-top: 10px; text-align: center; line-height: 1.4; }

/* æ»‘æ¡¿ */
.slider-container { margin: 20px 0; padding: 25px 20px; background: #fff8e1; border-radius: 12px; border: 2px dashed #f39c12; display: none; text-align: center; }
.slider-value-display { font-size: 1.2em; font-weight: bold; color: var(--primary); margin-bottom: 15px; }
.slider-label { display: flex; justify-content: space-between; font-size: 0.8em; color: #888; margin-bottom: 10px; }
input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; }
input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 26px; width: 26px; border-radius: 50%; background: var(--accent); cursor: pointer; margin-top: -11px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); border: 2px solid #fff; }
input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #ddd; border-radius: 3px; }

/* å½ˆçª— */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; animation: fadeIn 0.3s; }
.modal.show { display: flex; }
.modal-content { background-color: #fff; margin: auto; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; }
.modal-header { font-weight: bold; font-size: 1.2em; text-align: center; margin-bottom: 15px; color: var(--primary); }
.close-modal { position: absolute; right: 15px; top: 15px; font-size: 24px; color: #aaa; cursor: pointer; }
.zodiac-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.zodiac-btn { background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px 5px; text-align: center; cursor: pointer; font-size: 0.95em; transition: 0.2s; }
.zodiac-btn:hover { background: #eaf6ff; border-color: #3498db; }
.zodiac-icon { display: block; font-size: 1.5em; margin-bottom: 5px; }
</style>
</head>

<body>
<div class="container">
<div class="progress-bar"><div class="progress-fill" id="progress"></div></div>

<div id="step-intro" class="step active">
    <h2>ğŸ“Š å…¨æ–¹ä½ä¿éšªéœ€æ±‚æ¬Šé‡åˆ†æ</h2>
    <p>é€éç›´è¦ºçš„æƒ…å¢ƒæŠ‰æ“‡ï¼Œ<br>å”åŠ©æ‚¨é‡æ¸…å…§å¿ƒæœ€åœ¨æ„çš„ä¿éšœå„ªå…ˆç´šã€‚</p>

    <label>çœŸå¯¦å§“å</label><input id="clientName" type="text" placeholder="è«‹è¼¸å…¥ä¸­æ–‡æˆ–è‹±æ–‡å§“å">
    
    <label>ç”Ÿç†æ€§åˆ¥ (å½±éŸ¿è²»ç‡è¨ˆç®—)</label>
    <div class="radio-group">
        <label class="radio-label"><input type="radio" name="clientSex" value="ç”·">ç”·</label>
        <label class="radio-label"><input type="radio" name="clientSex" value="å¥³">å¥³</label>
    </div>
    
    <div style="display:flex; gap:10px;">
        <div style="flex:1">
            <label>å‡ºç”Ÿå¹´ä»½</label>
            <input id="clientDob" type="tel" placeholder="å¦‚: 75 æˆ– 1986">
        </div>
        <div style="flex:1">
            <label>æ˜Ÿåº§ (æ€§æ ¼åƒè€ƒ)</label>
            <input id="clientZodiac" type="text" placeholder="é»æ“Šé¸æ“‡ â–½" readonly onclick="openZodiacModal()">
        </div>
    </div>

    <label>è·æ¥­ (å¦‚: è‡ªç”±æ¥­/å·¥ç¨‹å¸«)</label><input id="clientJob" type="text" placeholder="è·æ¥­é¡åˆ¥">
    <label>è¯çµ¡æ–¹å¼ (æ‰‹æ©Ÿ / Line ID)</label><input id="clientContact" type="text" placeholder="æ–¹ä¾¿é¡§å•æä¾›å ±å‘Šçš„æ–¹å¼">

    <hr style="border:0; border-top:1px dashed #ccc; margin:20px 0;">
    <h3 style="color:var(--accent)">æœ¬æ¬¡è¦åŠƒå°è±¡</h3>
    <div class="option-pool">
        <button class="option-card" style="justify-content:center;font-weight:bold" onclick="selectTarget('self')">A. æˆ‘ç‚ºè‡ªå·±è¦åŠƒ</button>
        <button class="option-card" style="justify-content:center;font-weight:bold" onclick="selectTarget('family')">B. æˆ‘ç‚ºå®¶äºº (çˆ¶æ¯/é…å¶/å°å­©)è¦åŠƒ</button>
        <button class="option-card" id="btn-both" style="justify-content:center;font-weight:bold" onclick="showSlider()">C. è‡ªå·±ï¼‹å®¶äºº (é›™è»Œåˆ†æ)</button>
    </div>

    <div id="weight-slider-box" class="slider-container">
        <p style="margin:0 0 10px 0; font-weight:bold; color:#d35400;">âš–ï¸ åå¥½æ¨¡æ“¬å™¨</p>
        <div class="slider-value-display">
            è‡ªå·± <span id="val-self" style="color:#2980b9">50%</span> 
            <span style="color:#ccc">|</span> 
            å®¶äºº <span id="val-family" style="color:#c0392b">50%</span>
        </div>
        <input type="range" id="weightSlider" min="10" max="90" value="50" step="10" oninput="updateSliderDisplay(this.value)">
        <div class="slider-label"><span>é‡è¦–è‡ªå·±</span><span>é‡è¦–å®¶äºº</span></div>
        <button id="slider-confirm-btn" class="nav-btn ready" onclick="selectTarget('both')" style="margin-top:10px;">ç¢ºèªä¸¦é–‹å§‹ â”</button>
    </div>
</div>

<div id="step-question" class="step">
    <h4 id="q-category" style="color:#999;margin:0"></h4>
    <h3 id="q-text" style="margin-top:5px"></h3>
    <p id="q-instruction" style="color:var(--accent);font-size:0.95em;background:#fff3cd;padding:8px;border-radius:5px;display:inline-block;">è«‹å¾ 5 å€‹é¸é …ä¸­ï¼Œé¸å‡ºæ‚¨æœ€åœ¨æ„çš„ <b>å‰ 3 å</b></p>
    
    <div class="option-pool" id="q-options" style="margin-top:15px"></div>
    
    <button id="next-btn" class="nav-btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â”</button>
    
    <p id="reset-link" style="text-align:center;cursor:pointer;font-size:0.8em;color:#999;margin-top:10px" onclick="resetCurrentRank()">â†» é‡æ–°æ’åºæœ¬é¡Œ</p>
</div>

<div id="step-check" class="step">
    <h2>ğŸ›¡ï¸ æœ€å¾Œç¢ºèª</h2>
    <p style="font-weight:bold;font-size:1.1em">è«‹å•æ‚¨æ¸…æ¥šè‡ªå·±ç›®å‰èº«ä¸Šæ—¢æœ‰çš„<br>ã€Œæ‰€æœ‰ä¿éšœå…§å®¹ã€å—ï¼Ÿ</p>
    <p style="font-size:0.9em; color:#666">(è‹¥ä¸æ¸…æ¥šé¸ã€Œå¦ã€ï¼Œé¡§å•å°‡æœƒå”åŠ©æ‚¨é€²è¡Œä¿å–®å¥æª¢)</p>
    <div class="check-btn-group">
        <button class="check-btn yes" onclick="finishCheck(true)">âœ… æ˜¯ï¼Œæˆ‘å¾ˆæ¸…æ¥š</button>
        <button class="check-btn no" onclick="finishCheck(false)">âŒ å¦ï¼Œä¸å¤ªç¢ºå®š</button>
    </div>
</div>

<div id="step-result" class="step">
    <div id="final-message"><h2>ğŸ”„ æ­£åœ¨åˆ†æ...</h2><p>ç³»çµ±æ­£åœ¨é‹ç®—æ‚¨çš„é¢¨éšªæ¬Šé‡...</p></div>
    <div id="analysis-content"></div>
</div>

</div>

<div id="zodiacModal" class="modal" onclick="closeZodiacModal(event)">
    <div class="modal-content">
        <span class="close-modal" onclick="closeZodiacModal(event)">&times;</span>
        <div class="modal-header">è«‹é¸æ“‡æ‚¨çš„æ˜Ÿåº§</div>
        <div class="zodiac-grid">
            <div class="zodiac-btn" onclick="selectZodiac('ç‰¡ç¾Šåº§')"><span class="zodiac-icon">â™ˆ</span>ç‰¡ç¾Šåº§</div>
            <div class="zodiac-btn" onclick="selectZodiac('é‡‘ç‰›åº§')"><span class="zodiac-icon">â™‰</span>é‡‘ç‰›åº§</div>
            <div class="zodiac-btn" onclick="selectZodiac('é›™å­åº§')"><span class="zodiac-icon">â™Š</span>é›™å­åº§</div>
            <div class="zodiac-btn" onclick="selectZodiac('å·¨èŸ¹åº§')"><span class="zodiac-icon">â™‹</span>å·¨èŸ¹åº§</div>
            <div class="zodiac-btn" onclick="selectZodiac('ç…å­åº§')"><span class="zodiac-icon">â™Œ</span>ç…å­åº§</div>
            <div class="zodiac-btn" onclick="selectZodiac('è™•å¥³åº§')"><span class="zodiac-icon">â™</span>è™•å¥³åº§</div>
            <div class="zodiac-btn" onclick="selectZodiac('å¤©ç§¤åº§')"><span class="zodiac-icon">â™</span>å¤©ç§¤åº§</div>
            <div class="zodiac-btn" onclick="selectZodiac('å¤©è åº§')"><span class="zodiac-icon">â™</span>å¤©è åº§</div>
            <div class="zodiac-btn" onclick="selectZodiac('å°„æ‰‹åº§')"><span class="zodiac-icon">â™</span>å°„æ‰‹åº§</div>
            <div class="zodiac-btn" onclick="selectZodiac('æ‘©ç¾¯åº§')"><span class="zodiac-icon">â™‘</span>æ‘©ç¾¯åº§</div>
            <div class="zodiac-btn" onclick="selectZodiac('æ°´ç“¶åº§')"><span class="zodiac-icon">â™’</span>æ°´ç“¶åº§</div>
            <div class="zodiac-btn" onclick="selectZodiac('é›™é­šåº§')"><span class="zodiac-icon">â™“</span>é›™é­šåº§</div>
        </div>
    </div>
</div>

<script>
// ğŸ”´ è¨­å®šå€
const scriptURL = "https://script.google.com/macros/s/AKfycbwNNc9BZ0AJzTGGYK4cnqAsuA78FtWMuuVoJMmn4hZpOSWuVCy0N6eLyPk-h414ZkJD/exec";

// æ¬Šé‡è¨­å®š
const RANK_WEIGHTS = [5, 3, 1]; // å–®äººæ’åºç”¨
const PK_WEIGHT = 3; // PKé¸ä¸­å¾—3åˆ†

const TAG_MAP = {lump_sum:"ä¸€æ¬¡é‡‘",monthly_pay:"åˆ†æœŸé‡‘",medical:"å¯¦æ”¯å¯¦ä»˜",accident:"æ„å¤–é¢¨éšª",savings:"è³‡ç”¢ç´¯ç©"};

/* ===== å–®äººæ¨¡å¼é¡Œåº« (5 é¸ 3) - ç¶­æŒåŸæ¨£ ===== */
const questionsSelf=[{id:"A1",cat:"ã€ä¿éšœå•Ÿå‹•æ–¹å¼ã€‘",title:"ä½ å¸Œæœ›ä½ ç¹³å‡ºå»çš„ä¿è²»ï¼Œæœªä¾†ä»¥ä»€éº¼å½¢å¼å¹«åˆ°ä½ ï¼Ÿ",options:[{text:"ç”Ÿå¤§ç—…æ™‚ï¼Œä¸€æ¬¡çµ¦ä»˜ 100ï½200 è¬ï¼Œæˆ‘è‡ªå·±è™•ç†éŒ¢çš„æµå‘",tag:"lump_sum"},{text:"ç„¡æ³•å·¥ä½œæ™‚ï¼Œæ¯æœˆå›ºå®šçµ¦ä»˜ 3ï½5 è¬ï¼Œè£œè²¼è–ªæ°´",tag:"monthly_pay"},{text:"ä½é™¢æ‰‹è¡“æ™‚ï¼Œè²»ç”¨å¯¦å ±å¯¦éŠ·ï¼ŒæŠŠå¸³å–®è§£æ±ºæ‰",tag:"medical"},{text:"ç™¼ç”Ÿæ„å¤–æ™‚ï¼Œé‡å°éª¨æŠ˜å—å‚·çµ¦äºˆè£œè²¼",tag:"accident"},{text:"æ»¿æœŸæˆ–é€€ä¼‘æ™‚ï¼Œé€™ç­†éŒ¢èƒ½é€£æœ¬å¸¶åˆ©å›ä¾†ç•¶ä½œè³‡ç”¢",tag:"savings"}]},{id:"A2",cat:"ã€é¢¨éšªæ„Ÿå—ã€‘",title:"å“ªä¸€ç¨®ç‹€æ³ç™¼ç”Ÿï¼Œæœƒè®“ä½ å¿ƒç†å£“åŠ›æœ€å¤§ï¼Ÿ",options:[{text:"æ€¥éœ€ä¸€å¤§ç­†éŒ¢ï¼Œå­˜æ¬¾ç¬é–“æ­¸é›¶",tag:"lump_sum"},{text:"æ”¶å…¥ä¸­æ–·ï¼Œä½†ç”Ÿæ´»è²»å’Œè²¸æ¬¾é‚„åœ¨è·‘",tag:"monthly_pay"},{text:"ç‚ºäº†çœéŒ¢ï¼Œä¸æ•¢ç”¨æ¯”è¼ƒå¥½çš„è‡ªè²»æ²»ç™‚",tag:"medical"},{text:"å°æ„å¤–ä¸€ç›´ä¾†ï¼Œç´¯ç©æˆç„¡æ³•å·¥ä½œçš„è² æ“”",tag:"accident"},{text:"ä¸çŸ¥ä¸è¦ºæŠŠéŒ¢èŠ±å…‰ï¼Œé€€ä¼‘æˆ–è€å¹´æ™‚æ²’éŒ¢å¯ç”¨",tag:"savings"}]},{id:"A3",cat:"ã€è³‡é‡‘ç”¨é€”ã€‘",title:"é€™ç­†ç†è³ é‡‘(æˆ–è³‡é‡‘)ä¸‹ä¾†ï¼Œä½ æœ€ä¸»è¦æ˜¯æ‹¿ä¾†è§£æ±ºä»€éº¼ï¼Ÿ",options:[{text:"è§£æ±ºæ¨™é¶è—¥ç‰©è²»ï¼Œæˆ–ç”Ÿç—…æœŸé–“çš„é€±è½‰",tag:"lump_sum"},{text:"è§£æ±ºé•·æœŸçš„çœ‹è­·è²»ã€ç™‚é¤Šé™¢è²»ç”¨",tag:"monthly_pay"},{text:"è§£æ±ºä½é™¢æœŸé–“çš„ç—…æˆ¿è²»ã€æ‰‹è¡“é›œè²»",tag:"medical"},{text:"è§£æ±ºè·Œå€’ã€è»Šç¦å¾Œçš„å¾©å¥æˆ–è–ªæ°´æå¤±",tag:"accident"},{text:"è§£æ±ºã€Œæœªä¾†çš„éŒ¢ã€ï¼Œä¾‹å¦‚é€€ä¼‘é‡‘æˆ–å¼·è¿«å„²è“„",tag:"savings"}]},{id:"A4",cat:"ã€æ±ºç­–é¢¨æ ¼ã€‘",title:"ä½ æ¯”è¼ƒèƒ½æ¥å—å“ªä¸€ç¨®è¦åŠƒæ–¹å¼ï¼Ÿ",options:[{text:"å½ˆæ€§æœ€é«˜ï¼ŒéŒ¢æ‹¿åœ¨æ‰‹è£¡æˆ‘è‡ªå·±æ±ºå®š",tag:"lump_sum"},{text:"è¦å‰‡æ¸…æ¥šï¼Œæ¯æœˆéƒ½æœ‰ç¾é‡‘æµæ”¯æŒ",tag:"monthly_pay"},{text:"åŠŸèƒ½å°å‘ï¼Œç™¼ç”Ÿå°±ç›´æ¥è™•ç†ï¼Œä¸æƒ³ç…©æƒ±",tag:"medical"},{text:"åˆ†æ•£é¢¨éšªï¼Œä¸è®“å–®ä¸€çªç™¼äº‹ä»¶å½±éŸ¿ç”Ÿæ´»",tag:"accident"},{text:"ä¿æœ¬ç©©å®šï¼Œæˆ‘å¸Œæœ›éŒ¢ä¸€å®šè¦ç•™ä¸‹ä¾†æˆ–è®Šå¤š",tag:"savings"}]},{id:"A5",cat:"ã€å„ªå…ˆé †åºã€‘",title:"å¦‚æœè¦ä½ å…ˆåšä¸€é …æº–å‚™ï¼Œä½ æœƒå„ªå…ˆé¸ï¼Ÿ",options:[{text:"é‡å¤§å‚·ç—…éšª (è§£æ±ºç•¶ä¸‹æ€¥ç”¨)",tag:"lump_sum"},{text:"å¤±èƒ½/é•·ç…§éšª (è§£æ±ºé•·æœŸç”Ÿæ´»)",tag:"monthly_pay"},{text:"å¯¦æ”¯å¯¦ä»˜é†«ç™‚ (è§£æ±ºé†«é™¢å¸³å–®)",tag:"medical"},{text:"æ„å¤–éšª (è§£æ±ºçªç™¼äº‹æ•…)",tag:"accident"},{text:"è³‡ç”¢ç´¯ç© (é€€ä¼‘/å‚³æ‰¿/å¼·è¿«å„²è“„)",tag:"savings"}]}];
const questionsFamily=[{id:"B1",cat:"ã€ä¿éšœå•Ÿå‹•æ–¹å¼ã€‘",title:"å¹«å®¶äººè¦åŠƒæ™‚ï¼Œæ€æ¨£çš„çµæœæœ€èƒ½è®“ä½ å®‰å¿ƒï¼Ÿ",options:[{text:"çµ¦æˆ‘å€‘ä¸€æ•´ç­†éŒ¢ï¼Œè®“æˆ‘å€‘æ±ºå®šæ€éº¼æ•‘",tag:"lump_sum"},{text:"æ¯å€‹æœˆçµ¦ä»˜ï¼Œè£œè²¼ç…§è­·è²» (æˆ–è¾­è·ç…§é¡§çš„è–ªæ°´)",tag:"monthly_pay"},{text:"å¹«å¿™æŠŠé†«é™¢çš„æ”¶æ“šä»˜æ‰ï¼Œä¸ç”¨å‹•åˆ°å­˜æ¬¾",tag:"medical"},{text:"é‡å°æ„å¤–å—å‚·çµ¦äºˆè£œè²¼ï¼Œæ¸›è¼•é¡å¤–é–‹éŠ·",tag:"accident"},{text:"ç„¡è«–æœ‰æ²’æœ‰ç”Ÿç—…ï¼Œé€™ç­†éŒ¢éƒ½èƒ½ç•™çµ¦å­©å­æˆ–å®¶äºº",tag:"savings"}]},{id:"B2",cat:"ã€é¢¨éšªæ„Ÿå—ã€‘",title:"å¦‚æœäº‹æƒ…ç™¼ç”Ÿï¼Œå“ªç¨®ç‹€æ³å°å®¶åº­å½±éŸ¿æœ€å¤§ï¼Ÿ",options:[{text:"çªç„¶è¦æ‹¿å‡ºå¹¾åè¬ã€ä¸Šç™¾è¬çš„æ²»ç™‚è²»",tag:"lump_sum"},{text:"æ¯å€‹æœˆå¥½å¹¾è¬çš„é–‹éŠ·ï¼Œä¸”ä¸çŸ¥é“è¦ä»˜å¤šä¹…",tag:"monthly_pay"},{text:"é »ç¹é€²å‡ºé†«é™¢çš„å„é …é›œæ”¯èˆ‡é–‹éŠ·",tag:"medical"},{text:"çªç™¼æ„å¤–å°è‡´çš„æ··äº‚èˆ‡é¡å¤–èŠ±è²»",tag:"accident"},{text:"æ²’æœ‰ç‚ºæœªä¾†å­˜ä¸‹è¶³å¤ çš„éŒ¢ï¼Œå°è‡´ç”Ÿæ´»å“è³ªä¸‹é™",tag:"savings"}]},{id:"B3",cat:"ã€ç…§é¡§è€…çš„ç—›é»ã€‘",title:"èº«ç‚ºå®¶äººçš„ä½ ï¼Œæœ€æ€•é‡åˆ°å“ªç¨®æƒ…æ³ï¼Ÿ",options:[{text:"å› ç‚ºæ²’éŒ¢ï¼Œè¢«è¿«æ”¾æ£„æŸäº›æ²»ç™‚æ©Ÿæœƒ",tag:"lump_sum"},{text:"éœ€è¦é•·æœŸå°ˆäººç…§é¡§ï¼Œæ‹–å®å…¨å®¶ç¶“æ¿Ÿ",tag:"monthly_pay"},{text:"ä½é™¢è²»ç”¨å¤ªé«˜ï¼ŒçŒ¶è±«è¦ä¸è¦ç”¨è‡ªè²»",tag:"medical"},{text:"ç™¼ç”Ÿæ„å¤–æªæ‰‹ä¸åŠï¼Œæ‰“äº‚ç”Ÿæ´»ç¯€å¥",tag:"accident"},{text:"è¾›è‹¦è³ºçš„éŒ¢éƒ½èŠ±æ‰ï¼Œæ²’æœ‰ç•™æ±è¥¿çµ¦ä¸‹ä¸€ä»£",tag:"savings"}]},{id:"B4",cat:"ã€æ±ºç­–é¢¨æ ¼ã€‘",title:"å¹«å®¶äººè²·ä¿éšªï¼Œä½ æœ€åœ¨ä¹çš„æ˜¯ï¼Ÿ",options:[{text:"è³‡é‡‘è¦éˆæ´»ï¼Œé‡åˆ°å¤§ç—…æˆ‘æœ‰è³‡æºèª¿åº¦",tag:"lump_sum"},{text:"ç¾é‡‘æµè¦ç©©ï¼Œä¸è¦è®“æˆ‘æ¯å€‹æœˆç…©æƒ±éŒ¢",tag:"monthly_pay"},{text:"åŠŸèƒ½è¦å¯¦ç”¨ï¼Œè§£æ±ºæœ€å¸¸ç™¼ç”Ÿçš„é†«ç™‚å¸³å–®",tag:"medical"},{text:"ä¿è²»è¦ä¾¿å®œï¼Œå…ˆæ±‚æœ‰åŸºæœ¬çš„æ„å¤–é˜²è­·",tag:"accident"},{text:"éŒ¢è¦å®ˆä½ï¼Œå°ˆæ¬¾å°ˆç”¨ï¼Œä¸è¢«è¼•æ˜“æŒªç”¨",tag:"savings"}]},{id:"B5",cat:"ã€æœ€å¾Œåº•ç·šã€‘",title:"ä½ æœ€æƒ³ç‚ºå®¶äººå®ˆä½çš„åº•ç·šæ˜¯ï¼Ÿ",options:[{text:"é‡åˆ°å¤§ç—…æ™‚æœ‰ã€Œæ•‘å‘½éŒ¢ã€ï¼Œä¸ç•™éºæ†¾",tag:"lump_sum"},{text:"ç„¡è«–å¦‚ä½•ï¼Œç”Ÿæ´»å“è³ªä¸èƒ½è¢«é•·æœŸæ‹–å®",tag:"monthly_pay"},{text:"è®“å®¶äººæœ‰æ¬Šåˆ©é¸æ“‡ã€Œæœ€å¥½çš„é†«ç™‚å“è³ªã€",tag:"medical"},{text:"è¬ä¸€ç™¼ç”Ÿæ„å¤–ï¼Œç”Ÿæ´»é‚„èƒ½æ­£å¸¸é‹ä½œ",tag:"accident"},{text:"ç¢ºä¿æœªä¾†æœ‰ä¸€ç­†ç¢ºå®šçš„è³‡é‡‘(æ•™è‚²/é€€ä¼‘/å‚³æ‰¿)",tag:"savings"}]}];

/* ===== ğŸ”¥ V19.0 çµ±ä¸€é›™è»Œ PK é¡Œåº« (10é¡Œæ··å’Œæƒ…å¢ƒ) ===== */
const questionsUnifiedPK = [
    // 1-5 é¡Œï¼šåŸºæœ¬ä¿éšœè§€
    {cat:"ã€æƒ…å¢ƒæŠ‰æ“‡ 1/10ã€‘", title:"å¦‚æœåªèƒ½é¸ä¸€å€‹ï¼Œæ‚¨æ¯”è¼ƒåœ¨æ„ï¼Ÿ", options:[{text:"è§£æ±ºã€Œæ„å¤–å—å‚·ã€çš„çªç™¼é–‹éŠ·",tag:"accident", desc:"(å¦‚éª¨æŠ˜ã€è»Šç¦)"}, {text:"è§£æ±ºã€Œç”Ÿç—…ä½é™¢ã€çš„é†«ç™‚å¸³å–®",tag:"medical", desc:"(å¦‚æ‰‹è¡“ã€é›œè²»)"}]},
    {cat:"ã€æƒ…å¢ƒæŠ‰æ“‡ 2/10ã€‘", title:"ç•¶éœ€è¦é•·æœŸä¼‘é¤Šæ™‚ï¼Œæ‚¨å¸Œæœ›ï¼Ÿ", options:[{text:"æ‹¿åˆ°ä¸€æ•´ç­†éŒ¢ï¼Œè‡ªå·±èª¿åº¦",tag:"lump_sum", desc:"(å½ˆæ€§é«˜)"}, {text:"æ¯å€‹æœˆæœ‰å›ºå®šç”Ÿæ´»è²»å…¥å¸³",tag:"monthly_pay", desc:"(ç´°æ°´é•·æµ)"}]},
    {cat:"ã€æƒ…å¢ƒæŠ‰æ“‡ 3/10ã€‘", title:"é—œæ–¼é‡‘éŒ¢é‹ç”¨ï¼Œæ‚¨çš„åŸå‰‡æ˜¯ï¼Ÿ", options:[{text:"æŠŠéŒ¢å­˜ä¸‹ä¾†ï¼Œç´¯ç©æˆè³‡ç”¢",tag:"savings", desc:"(ä¿æœ¬å¢å€¼)"}, {text:"æŠŠéŒ¢èŠ±åœ¨æœ€å¥½çš„é†«ç™‚å“è³ª",tag:"medical", desc:"(äº«å—ç•¶ä¸‹)"}]},
    {cat:"ã€æƒ…å¢ƒæŠ‰æ“‡ 4/10ã€‘", title:"æ‚¨æ¯”è¼ƒæ“”å¿ƒå®¶è£¡ç™¼ç”Ÿï¼Ÿ", options:[{text:"æœ‰äºº(åŒ…å«è‡ªå·±)å› ç—…å€’ä¸‹ï¼Œæ”¶å…¥ä¸­æ–·",tag:"monthly_pay", desc:"(é•·æœŸæŠ—æˆ°)"}, {text:"çªç„¶éœ€è¦ç±Œæªç™¾è¬æ‰‹è¡“è²»",tag:"lump_sum", desc:"(çŸ­æœŸé‡æ“Š)"}]},
    {cat:"ã€æƒ…å¢ƒæŠ‰æ“‡ 5/10ã€‘", title:"å°æ–¼æœªä¾†ï¼Œæ‚¨æ›´æƒ³ç¢ºä¿ï¼Ÿ", options:[{text:"é€€ä¼‘é‡‘æˆ–å‚³æ‰¿é‡‘æº–å‚™å¥½äº†",tag:"savings", desc:"(ç¢ºå®šæ€§)"}, {text:"ç™¼ç”Ÿæ„å¤–æ™‚ä¸æœƒæ‹–ç´¯å®¶äºº",tag:"accident", desc:"(é˜²è­·ç¶²)"}]},
    
    // 6-10 é¡Œï¼šé€²éšåƒ¹å€¼è§€
    {cat:"ã€æƒ…å¢ƒæŠ‰æ“‡ 6/10ã€‘", title:"å¦‚æœä¿è²»é ç®—æœ‰é™ï¼Œå„ªå…ˆç æ‰ï¼Ÿ", options:[{text:"å„²è“„æŠ•è³‡ (å…ˆé¡§ä¿éšœ)",tag:"medical", desc:"(ä¿ç•™é†«ç™‚)"}, {text:"é†«ç™‚ä¿éšœ (å…ˆé¡§å­˜éŒ¢)",tag:"savings", desc:"(ä¿ç•™å„²è“„)"}]},
    {cat:"ã€æƒ…å¢ƒæŠ‰æ“‡ 7/10ã€‘", title:"é¢å°ç„¡æ³•å·¥ä½œçš„é¢¨éšªï¼Œæ‚¨åå¥½ï¼Ÿ", options:[{text:"ä¸€æ¬¡æ‹¿èµ° 200 è¬",tag:"lump_sum", desc:"(è½è¢‹ç‚ºå®‰)"}, {text:"æ¯å€‹æœˆæ‹¿ 3 è¬é ˜ 10 å¹´",tag:"monthly_pay", desc:"(ç¸½é¡è¼ƒå¤š)"}]},
    {cat:"ã€æƒ…å¢ƒæŠ‰æ“‡ 8/10ã€‘", title:"æ‚¨èªç‚ºä¿éšªæœ€è©²è§£æ±ºçš„æ˜¯ï¼Ÿ", options:[{text:"æ©Ÿç‡é«˜ã€é‡‘é¡å°çš„(é–€è¨º/æ„å¤–)",tag:"accident", desc:"(å¸¸ç”¨)"}, {text:"æ©Ÿç‡ä½ã€é‡‘é¡å¤§çš„(ç™Œç—‡/å¤±èƒ½)",tag:"lump_sum", desc:"(æ•‘å‘½)"}]},
    {cat:"ã€æƒ…å¢ƒæŠ‰æ“‡ 9/10ã€‘", title:"é—œæ–¼å®¶äººçš„ä¿éšœï¼Œæ‚¨æ›´åœ¨æ„ï¼Ÿ", options:[{text:"ä¸è¦è®“ä¸€å€‹äººçš„ç—…æ‹–å®å…¨å®¶",tag:"monthly_pay", desc:"(é¿å…è² å‚µ)"}, {text:"è®“å®¶äººæœ‰éŒ¢æ¥å—æœ€å¥½æ²»ç™‚",tag:"medical", desc:"(é†«ç™‚äººæ¬Š)"}]},
    {cat:"ã€æƒ…å¢ƒæŠ‰æ“‡ 10/10ã€‘", title:"æœ€å¾Œä¸€é¡Œï¼Œæ‚¨å¸Œæœ›é€™ä»½è¦åŠƒï¼Ÿ", options:[{text:"åƒé˜²è­·ç½©ï¼Œæ“‹ä½æ‰€æœ‰é¢¨éšª",tag:"accident", desc:"(å…¨éšªè£œç¼ºå£)"}, {text:"åƒèšå¯¶ç›†ï¼ŒéŒ¢èƒ½çµ¦æƒ³çµ¦çš„äºº",tag:"savings", desc:"(ç§˜å¯†ç¦®ç‰©)"}]}
];

let currentMode="", currentQueue=[], answers=[], currentIndex=0, currentRank=[], familyWeight=0.5, isSubmitting=false;

// UI & å½ˆçª—é‚è¼¯
function updateSliderDisplay(val) { let f=parseInt(val); let s=100-f; document.getElementById("val-self").innerText=s+"%"; document.getElementById("val-family").innerText=f+"%"; }
function showSlider() { document.getElementById("btn-both").style.display="none"; document.getElementById("weight-slider-box").style.display="block"; }
function openZodiacModal(){ document.getElementById("zodiacModal").classList.add("show"); }
function closeZodiacModal(e){ if(e.target===document.getElementById("zodiacModal")||e.target.classList.contains("close-modal"))document.getElementById("zodiacModal").classList.remove("show"); }
function selectZodiac(v){ document.getElementById("clientZodiac").value=v; document.getElementById("zodiacModal").classList.remove("show"); }

function selectTarget(mode){
  if(isSubmitting)return; isSubmitting=true;
  const name=document.getElementById("clientName").value.trim();
  const sex=[...document.getElementsByName("clientSex")].find(x=>x.checked)?.value;
  const zodiac=document.getElementById("clientZodiac").value;
  if(!name||name.length<2||!sex||!zodiac){alert("è«‹å®Œæ•´å¡«å¯«è³‡æ–™ï¼");isSubmitting=false;return;}
  
  if(mode==='both'){ let s=document.getElementById('weightSlider').value; familyWeight=s/100; let b=document.getElementById("slider-confirm-btn"); if(b)b.innerHTML="è™•ç†ä¸­..."; }
  else if(mode==='self'){familyWeight=0;} else{familyWeight=1;}

  setTimeout(()=>{
    currentMode=mode; document.getElementById("weight-slider-box").style.display="none";
    // ğŸ”¥ V19.0 é¡Œåº«åˆ†æµ
    currentQueue = (mode==='both') ? questionsUnifiedPK : ((mode==='family')?questionsFamily:questionsSelf);
    
    document.getElementById("step-intro").classList.remove("active");
    document.getElementById("step-question").classList.add("active");
    
    // UI èª¿æ•´
    if(mode==='both'){
        document.getElementById("q-instruction").innerHTML = "âš¡ <b>ç›´è¦ºäºŒé¸ä¸€ï¼š</b>è«‹é»æ“Šæ‚¨è¼ƒå‚¾å‘çš„é¸é …";
        document.getElementById("reset-link").style.display = "none";
        document.getElementById("next-btn").style.display = "none"; // PKæ¨¡å¼é»æ“Šå³é¸
    } else {
        document.getElementById("q-instruction").innerHTML = "è«‹å¾ 5 å€‹é¸é …ä¸­ï¼Œé¸å‡ºæ‚¨æœ€åœ¨æ„çš„ <b>å‰ 3 å</b>";
        document.getElementById("reset-link").style.display = "block";
        document.getElementById("next-btn").style.display = "block";
    }

    loadQuestion(); isSubmitting=false;
  }, 300);
}

function loadQuestion(){
  if(currentIndex>=currentQueue.length){handleQueueFinish();return;}
  currentRank=[];
  const q=currentQueue[currentIndex];
  document.getElementById("q-category").innerText=q.cat;
  document.getElementById("q-text").innerText=q.title;
  renderOptions();
}

function renderOptions(){
  const q=currentQueue[currentIndex];
  const pool=document.getElementById("q-options");pool.innerHTML="";
  
  if(currentMode === 'both') {
      // ğŸ”¥ V19.0 é›™è»Œ PK å¡ç‰‡
      pool.style.flexDirection = "row"; 
      pool.innerHTML = `<div class="pk-container" style="width:100%"></div>`;
      let container = pool.querySelector(".pk-container");
      
      q.options.forEach((o,i)=>{
          let div = document.createElement("div");
          div.className = "pk-card";
          // æ”¯æ´é¡¯ç¤ºå‰¯æ¨™é¡Œ desc
          let descHtml = o.desc ? `<div class="pk-desc">${o.desc}</div>` : "";
          div.innerHTML = `<div class="pk-title">${o.text}</div>${descHtml}`;
          div.onclick = () => selectPK(i); 
          container.appendChild(div);
      });
      let vs = document.createElement("div");
      vs.className = "pk-vs"; vs.innerText = "VS";
      pool.style.position = "relative";
      pool.appendChild(vs);

  } else {
      // æ¨™æº–æ¨¡å¼åˆ—è¡¨
      pool.style.flexDirection = "column";
      let vs = pool.querySelector(".pk-vs"); if(vs) vs.remove(); 
      q.options.forEach((o,i)=>{
        const idx=currentRank.indexOf(i);
        const div=document.createElement("div");
        div.className="option-card"+(idx>-1?" selected":"");
        div.onclick=()=>toggleOption(i);
        div.innerHTML=`<div class="rank-box">${idx>-1?idx+1:""}</div><div class="option-text">${o.text}</div>`;
        pool.appendChild(div);
      });
      const btn=document.getElementById("next-btn");
      btn.classList.toggle("ready",currentRank.length===3);
  }
}

function toggleOption(i){
  const idx=currentRank.indexOf(i);
  if(idx>-1){currentRank.splice(idx,1);}else{if(currentRank.length<3)currentRank.push(i);}
  renderOptions();
}

// PKæ¨¡å¼ï¼šé»æ“Šå³éŒ„å…¥
function selectPK(i){
    const q=currentQueue[currentIndex];
    answers.push({
        mode: "mixed", // æ··åˆæ¨¡å¼
        tags: [q.options[i].tag]
    });
    currentIndex++; loadQuestion();
}

function nextQuestion(){
  if(currentMode!=='both' && currentRank.length<3)return;
  const q=currentQueue[currentIndex];
  answers.push({
      mode: currentQueue===questionsSelf?"self":"family",
      tags: currentRank.map(i=>q.options[i].tag)
  });
  currentIndex++;loadQuestion();
}

function resetCurrentRank(){currentRank=[];renderOptions();}

function handleQueueFinish(){
  // é›™è»Œæˆ–å–®äººéƒ½ç›´æ¥çµæŸ
  document.getElementById("step-question").classList.remove("active");
  document.getElementById("step-check").classList.add("active");
}

function finishCheck(isKnown){
  document.getElementById("step-check").classList.remove("active");
  document.getElementById("step-result").classList.add("active");

  const name = document.getElementById("clientName").value.trim();
  const dob = document.getElementById("clientDob").value;
  const zodiac = document.getElementById("clientZodiac").value;
  const job = document.getElementById("clientJob").value;
  const sex = [...document.getElementsByName("clientSex")].find(x=>x.checked)?.value;
  const isValidName = /^[\u4e00-\u9fa5_a-zA-Z0-9 ]{2,20}$/.test(name) && !/æ¸¬è©¦|test|admin|123/.test(name.toLowerCase());

  // è¨ˆåˆ†å®¹å™¨ï¼šMixed æ¨¡å¼å…±ç”¨
  let scores={self:{}, family:{}, mixed:{}};
  ["lump_sum","monthly_pay","medical","accident","savings"].forEach(k=>{ 
      scores.self[k]=0; scores.family[k]=0; scores.mixed[k]=0; 
  });

  let hasFirstPlaceSavings = false;

  answers.forEach(a => {
      if (a.mode === "mixed") {
          // PKæ¨¡å¼ï¼šç›´æ¥åŠ åˆ†åˆ° mixed
          scores.mixed[a.tags[0]] += PK_WEIGHT;
          if(a.tags[0] === 'savings') hasFirstPlaceSavings = true;
      } else {
          // æ’åºæ¨¡å¼
          a.tags.forEach((t, i) => {
              scores[a.mode][t] += RANK_WEIGHTS[i];
              if(t === 'savings' && i === 0) hasFirstPlaceSavings = true;
          });
      }
  });

  // è¨ˆç®—ç¸½åˆ† (å€åˆ†æ¨¡å¼)
  let totalLumpSum=0, totalMonthly=0, totalSavings=0, totalMedical=0, totalAccident=0;

  if (currentMode === 'both') {
      // é›™è»Œæ¨¡å¼ï¼šçœ‹ mixed åˆ†æ•¸
      totalLumpSum = scores.mixed.lump_sum;
      totalMonthly = scores.mixed.monthly_pay;
      totalSavings = scores.mixed.savings;
      totalMedical = scores.mixed.medical;
      totalAccident = scores.mixed.accident;
  } else {
      // å–®äººæ¨¡å¼ï¼šçœ‹å°æ‡‰åˆ†æ•¸ (self or family)
      let m = currentMode;
      totalLumpSum = scores[m].lump_sum;
      totalMonthly = scores[m].monthly_pay;
      totalSavings = scores[m].savings;
      totalMedical = scores[m].medical;
      totalAccident = scores[m].accident;
  }

  let totalScore = totalLumpSum + totalMonthly + totalSavings + totalMedical + totalAccident;
  let savingsRatio = totalScore > 0 ? (totalSavings / totalScore) : 0;
  // é›™è»ŒPKæ¨¡å¼ç¸½åˆ†è¼ƒä½(30åˆ†)ï¼Œå·®è·é–€æª»è¨­ç‚º 3ï¼›å–®äººæ’åºæ¨¡å¼ç¸½åˆ†è¼ƒé«˜ï¼Œè¨­ç‚º 4
  const GAP_THRESHOLD = currentMode === 'both' ? 3 : 4; 
  let moneyDiff = Math.abs(totalLumpSum - totalMonthly);
  let riskDiff = Math.abs(totalMedical - totalAccident);

  let frontendTypeTitle = "", frontendTypeClass = "", frontendDesc = "", frontendBadges = "";

  // åˆ¤å®šé‚è¼¯ (é€šç”¨)
  if (savingsRatio >= 0.25 && hasFirstPlaceSavings) { 
      frontendTypeTitle = "ğŸŸª è³‡ç”¢ç´¯ç©å‹ (å°ˆæ¬¾å°ˆç”¨)"; 
      frontendTypeClass = "result-type-4";
      frontendDesc = "æ‚¨çš„é¸æ“‡é¡¯ç¤ºï¼Œæ‚¨éå¸¸é‡è¦–è³‡ç”¢çš„ã€Œç¢ºå®šæ€§ã€ã€‚ç›¸æ¯”æ–¼ç™¼ç”Ÿé¢¨éšªå¾Œçš„è£œå„Ÿï¼Œæ‚¨æ›´å‚¾å‘æ–¼ç¢ºä¿è³‡é‡‘èƒ½å¤ ç•™å­˜ä¸‹ä¾†ã€‚";
      frontendBadges += `<span class="tag-badge bg-purple">â˜… é‡è¦–ä¿æœ¬</span><span class="tag-badge bg-purple">â˜… å°ˆæ¬¾å°ˆç”¨</span>`;
  } else {
      if(moneyDiff <= GAP_THRESHOLD) { 
          frontendTypeTitle = "ğŸŸ© å…¨æ–¹ä½è€ƒé‡å‹ (å‡è¡¡æ¢ç´¢)"; 
          frontendTypeClass = "result-type-2";
          frontendDesc = "æ­å–œï¼æ‚¨å…·å‚™éå¸¸å…¨é¢çš„é¢¨éšªæ„è­˜ã€‚æ•¸æ“šé¡¯ç¤ºæ‚¨å°ã€Œè³‡é‡‘éˆæ´»åº¦ã€èˆ‡ã€Œé•·æœŸç©©å®šæ€§ã€åŒæ¨£é‡è¦–ï¼Œä¸åå»¢ä»»ä½•ä¸€æ–¹ã€‚";
          frontendBadges += `<span class="tag-badge bg-green">â˜… é—œæ³¨å…¨é¢</span><span class="tag-badge bg-green">â˜… å½ˆæ€§é…ç½®</span>`;
      } else if (totalLumpSum > totalMonthly) {
          frontendTypeTitle = "ğŸŸ¦ é«˜åº¦è‡ªç•™å‹ (è³‡é‡‘æŒæ§)"; 
          frontendTypeClass = "result-type-1";
          frontendDesc = "æ‚¨å‚¾å‘ã€ŒæŠŠé¸æ“‡æ¬Šç•™åœ¨è‡ªå·±æ‰‹ä¸Šã€ã€‚é‡åˆ°ç‹€æ³æ™‚ï¼Œæ‚¨å¸Œæœ›æ“æœ‰ä¸€ç­†å¤§é¡è³‡é‡‘ï¼Œèƒ½å¤ éˆæ´»èª¿åº¦èˆ‡é‹ç”¨ã€‚";
          frontendBadges += `<span class="tag-badge bg-blue">â˜… è³‡é‡‘éˆæ´»</span><span class="tag-badge bg-blue">â˜… ç•¶ä¸‹æ±ºç­–</span>`;
      } else {
          frontendTypeTitle = "ğŸŸ¨ åˆ†æ•£å®‰æ’å‹ (ç´°æ°´é•·æµ)"; 
          frontendTypeClass = "result-type-3";
          frontendDesc = "æ‚¨å‚¾å‘ã€Œå»ºç«‹ç©©å®šçš„ä¿è­·ç¶²ã€ã€‚æ¯”èµ·è‡¨æ™‚ç±ŒéŒ¢ï¼Œæ‚¨æ›´å¸Œæœ›æœ‰ç©©å®šçš„ç¾é‡‘æµæ”¯æŒï¼Œä¸è®“ç”Ÿæ´»ç¯€å¥è¢«æ‰“äº‚ã€‚";
          frontendBadges += `<span class="tag-badge bg-orange">â˜… é•·æœŸç©©å®š</span><span class="tag-badge bg-orange">â˜… é¢¨éšªåˆ†æ•£</span>`;
      }
  }

  if (riskDiff <= GAP_THRESHOLD) frontendBadges += `<span class="tag-badge bg-green">ğŸ›¡ï¸ å…¨éšªé˜²è­·</span>`;
  else if (totalMedical > totalAccident) frontendBadges += `<span class="tag-badge bg-blue">ğŸ¥ é‡è¦–é†«ç™‚å“è³ª</span>`;
  else frontendBadges += `<span class="tag-badge bg-orange">âš ï¸ é‡è¦–æ„å¤–é¢¨éšª</span>`;

  // ä¿è²»æ¨ç®— & å ±å‘Šç”Ÿæˆ
  let incomeLevel = 2; if (job && job.match(/é†«|å¸«|é•·|ç†|ç¶“|è‘£|ç¸½/)) incomeLevel = 3; if (job && job.match(/ç”Ÿ|ç®¡|åŠ©|å“¡|å·¥/)) incomeLevel = 1; 
  let willingnessMultiplier = 1.0; if (savingsRatio >= 0.3) willingnessMultiplier = 2.5; else if (savingsRatio >= 0.15) willingnessMultiplier = 1.5; else willingnessMultiplier = 0.8; 
  let basePremium = 3 * incomeLevel; let safeLine = Math.round(basePremium * 0.5); let standardLine = Math.round(basePremium * willingnessMultiplier); let dreamLine = Math.round(basePremium * willingnessMultiplier * 1.8); 

  let report = `ã€ğŸ§‘ å®¢æˆ¶æª”æ¡ˆã€‘\nå§“åï¼š${name} (${sex})\nå¹´æ¬¡ï¼š${dob} / æ˜Ÿåº§ï¼š${zodiac}\nè·æ¥­ï¼š${job}\nä¿å–®å¥æª¢ï¼š${isKnown ? "æ¸…æ¥š" : "âš ï¸ ä¸æ¸…æ¥š"}\n`;
  if(currentMode==='both') report += `æ¬Šé‡è¨­å®šï¼šè‡ªå·± ${(1-familyWeight)*100}% / å®¶äºº ${familyWeight*100}% (PKæ··åˆæ¨¡å¼)\n`;
  if(!isValidName) report += `âš ï¸ [ç³»çµ±æ¨™è¨˜] ç–‘ä¼¼ç„¡æ•ˆåå–®\n`;
  report += `------------------------\n`;
  report += `ã€ğŸ’° å»ºè­°é–‹å£å€é–“ã€‘\nğŸ›¡ï¸ é˜²å®ˆï¼š${safeLine}è¬\nğŸ¯ é€²æ”»ï¼š${standardLine}è¬\nğŸš€ å¤©èŠ±æ¿ï¼š${dreamLine}è¬\n\n`;
  report += `ã€ğŸš€ æ•¸æ“šè‰™ã€‘\nä¸»é¡å‹ï¼š${frontendTypeTitle}\nå„²è“„ä½”æ¯”ï¼š${(savingsRatio*100).toFixed(1)}%\n`;
  
  // åŸå§‹åˆ†æ•¸å‚³é€
  function sort(o){return Object.entries(o).sort((a,b)=>b[1]-a[1]);}
  if(currentMode === 'both') {
      report += `[æ··åˆPKåˆ†] ` + sort(scores.mixed).map(s=>`${TAG_MAP[s[0]]}:${s[1]}`).join(", ");
  } else {
      let m = currentMode;
      report += `[${m==='self'?'è‡ªæˆ‘':'å®¶äºº'}æ’åºåˆ†] ` + sort(scores[m]).map(s=>`${TAG_MAP[s[0]]}:${s[1]}`).join(", ");
  }

  fetch(scriptURL, {
    method: "POST", mode: "no-cors", headers: {"Content-Type": "text/plain"},
    body: JSON.stringify({ name: name, mode: currentMode, analysis: report })
  })
  .then(() => {
      document.getElementById("final-message").style.display = "none";
      let resultContainer = document.getElementById("analysis-content");
      let contactText = isValidName ? "ç³»çµ±å·²å°‡æ‚¨çš„åå¥½æ¬Šé‡å‚³é€çµ¦é¡§å•ã€‚é¡§å•å°‡æ ¹æ“šæ‚¨çš„ã€Œè³‡ç”¢åå¥½ã€èˆ‡ã€Œé¢¨éšªå±¬æ€§ã€ï¼Œç‚ºæ‚¨è¦åŠƒæœ€é©åˆçš„æ–¹æ¡ˆã€‚" : "åˆ†æå·²å®Œæˆã€‚";
      let html = `<div style="text-align:center; margin-bottom:20px;"><h2 style="color: #27ae60; margin:0;">âœ… åˆ†æå®Œæˆ</h2><p>æ„Ÿè¬æ‚¨çš„å¡«å¯«ï¼ä»¥ä¸‹æ˜¯æ‚¨çš„åˆ†æçµæœï¼š</p></div><div class="result-card ${frontendTypeClass}"><span class="result-title" style="color:var(--primary)">${frontendTypeTitle}</span><div style="margin-bottom:15px;">${frontendBadges}</div><div class="result-desc">${frontendDesc}</div><div class="strategy-box"><b>ğŸ’¡ é¡§å•å»ºè­°ï¼š</b><br>${contactText}</div></div><div class="disclaimer">æœ¬åˆ†æçµæœåƒ…ä¾›ä¿éšªéœ€æ±‚åå¥½åƒè€ƒï¼Œä¸ä»£è¡¨æ‚¨çš„ä¿éšœå·²è¶³å¤ æˆ–ä¸è¶³ã€‚<br>å¯¦éš›è¦åŠƒä»éœ€è€ƒé‡æ‚¨çš„å¹´é½¡ã€é ç®—åŠæ—¢æœ‰ä¿éšœå…§å®¹ã€‚</div>`;
      if(!isKnown && isValidName) html += `<div style="background:#fff3cd;color:#856404;padding:15px;border-radius:8px;margin-top:20px;text-align:center;"><strong>ğŸ’¡ è²¼å¿ƒæé†’</strong><br>å»ºè­°é ç´„ä¿å–®å¥æª¢ï¼Œé¿å…é‡è¤‡æŠ•ä¿ï¼</div>`;
      html += `<button class="nav-btn ready" onclick="location.reload()" style="margin-top:30px">é—œé–‰</button>`;
      resultContainer.innerHTML = html;
  })
  .catch(() => alert("å‚³é€å¤±æ•—"));
}
</script>
</body>
</html>

