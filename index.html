<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¨æ–¹ä½ä¿éšªéœ€æ±‚æ¬Šé‡åˆ†æ</title>

<style>
:root {
  --primary:#2c3e50;
  --accent:#e74c3c;
  --selected:#27ae60;
  --bg:#f8f9fa;
  --card:#ffffff;
  --text:#333;
}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);margin:0;padding:20px;
  display:flex;justify-content:center;align-items:center;min-height:100vh;
}
.container{
  background:var(--card);max-width:620px;width:100%;
  padding:30px;border-radius:12px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
  position: relative;
}
h2,h3,h4{text-align:center;color:var(--primary);}
p{text-align:center;color:#666;line-height:1.6}
.progress-bar{height:6px;background:#eee;border-radius:3px;margin-bottom:20px;overflow:hidden}
.progress-fill{height:100%;background:var(--accent);width:0%;transition:.3s}

input[type=text],input[type=tel]{
  width:100%;padding:12px;margin-bottom:15px;
  border:1px solid #ddd;border-radius:6px;font-size:16px;
  box-sizing: border-box;
}
.radio-group{display:flex;gap:10px;margin-bottom:15px}
.radio-label{
  flex:1;border:1px solid #ddd;border-radius:6px;
  padding:10px;display:flex;align-items:center;gap:6px;cursor:pointer;
}

.option-pool{display:flex;flex-direction:column;gap:12px}
.option-card{
  border:2px solid #e0e0e0;border-radius:10px;
  padding:15px;cursor:pointer;
  display:flex;align-items:center;transition:.2s
}
.option-card:hover{background:#f9f9f9}
.option-card.selected{border-color:var(--selected);background:#f0fff4}
.rank-box{
  width:32px;height:32px;border-radius:6px;
  border:2px solid #ccc;margin-right:12px;
  display:flex;align-items:center;justify-content:center;
  font-weight:bold;flex-shrink:0;background:#fff;
}
.option-card.selected .rank-box{
  background:var(--selected);color:#fff;border-color:var(--selected)
}

.nav-btn{
  width:100%;padding:14px;border:none;border-radius:6px;
  font-size:16px;margin-top:20px;
  background:#aaa;color:#fff;opacity:.5;pointer-events:none;transition:.3s;
}
.nav-btn.ready{background:var(--accent);opacity:1;pointer-events:auto}

.step{display:none; animation: fadeIn 0.4s;}
.step.active{display:block}

@keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

.check-btn-group{display:flex;gap:15px;margin-top:20px}
.check-btn{
  flex:1;padding:15px;border-radius:8px;
  border:2px solid #ddd;background:#fff;font-weight:bold;cursor:pointer
}
.check-btn.yes{border-color:var(--selected);color:var(--selected)}
.check-btn.no{border-color:var(--accent);color:var(--accent)}

/* çµæœé æ¨£å¼ */
.result-card {
    border-radius: 10px; padding: 20px; margin-top: 20px; text-align: left;
    color: #333; border-left: 6px solid #ccc; background: #f9f9f9;
}
.result-type-1 { border-left-color: #3498db; background: #eaf6ff; } /* è— */
.result-type-2 { border-left-color: #27ae60; background: #eaffea; } /* ç¶  */
.result-type-3 { border-left-color: #f1c40f; background: #fffbe6; } /* é»ƒ */

.result-title { font-size: 1.4em; font-weight: bold; margin-bottom: 10px; display:block; }
.result-desc { font-size: 0.95em; line-height: 1.6; color: #555; }
.result-list { margin: 10px 0; padding-left: 20px; }
.result-list li { margin-bottom: 5px; }
</style>
</head>

<body>
<div class="container">
<div class="progress-bar"><div class="progress-fill" id="progress"></div></div>

<div id="step-intro" class="step active">
<h2>ğŸ“Š ä¿éšªéœ€æ±‚æ¬Šé‡åˆ†æ</h2>
<p>è«‹å”åŠ©å¡«å¯«åŸºæœ¬è³‡æ–™ï¼Œ<br>è®“æˆ‘å€‘èƒ½æä¾›ç²¾æº–çš„ä¿éšœå»ºè­°ã€‚</p>

<label>å§“å</label><input id="clientName" type="text" placeholder="è«‹è¼¸å…¥å§“å">
<label>æ€§åˆ¥</label>
<div class="radio-group">
<label class="radio-label"><input type="radio" name="clientSex" value="ç”·">ç”·</label>
<label class="radio-label"><input type="radio" name="clientSex" value="å¥³">å¥³</label>
</div>
<label>ç”Ÿæ—¥ (å¦‚: 19850101)</label><input id="clientDob" type="tel" placeholder="YYYYMMDD" maxlength="8">
<label>è·æ¥­</label><input id="clientJob" type="text" placeholder="ä¾‹å¦‚: å·¥ç¨‹å¸«">
<label>è¯çµ¡æ–¹å¼ (æ‰‹æ©Ÿ/Line)</label><input id="clientContact" type="text" placeholder="09xxxxxxxx">

<hr style="border:0; border-top:1px dashed #ccc; margin:20px 0;">
<h3 style="color:var(--accent)">æœ¬æ¬¡è¦åŠƒå°è±¡</h3>
<div class="option-pool">
<button class="option-card" style="justify-content:center;font-weight:bold" onclick="selectTarget('self')">A. åªæœ‰æˆ‘è‡ªå·±</button>
<button class="option-card" style="justify-content:center;font-weight:bold" onclick="selectTarget('family')">B. åªæœ‰å®¶äºº</button>
<button class="option-card" style="justify-content:center;font-weight:bold" onclick="selectTarget('both')">C. è‡ªå·±ï¼‹å®¶äºº</button>
</div>
</div>

<div id="step-question" class="step">
<h4 id="q-category" style="color:#999;margin:0"></h4>
<h3 id="q-text" style="margin-top:5px"></h3>
<p style="color:var(--accent);font-size:0.9em">è«‹ä¾ç…§é‡è¦–ç¨‹åº¦é»é¸ 1ï½4 å</p>
<div class="option-pool" id="q-options"></div>
<button id="next-btn" class="nav-btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â”</button>
<p style="text-align:center;cursor:pointer;font-size:0.8em;color:#999;margin-top:10px" onclick="resetCurrentRank()">â†» é‡æ–°æ’åºæœ¬é¡Œ</p>
</div>

<div id="step-check" class="step">
<h2>ğŸ›¡ï¸ æœ€å¾Œç¢ºèª</h2>
<p style="font-weight:bold;font-size:1.1em">è«‹å•æ‚¨æ¸…æ¥šè‡ªå·±ç›®å‰èº«ä¸Šæ—¢æœ‰çš„<br>ã€Œæ‰€æœ‰ä¿éšœå…§å®¹ã€å—ï¼Ÿ</p>
<p style="font-size:0.9em">(åŒ…å«å…¬å¸åœ˜ä¿ã€çˆ¶æ¯è²·çš„ä¿å–®...ç­‰)</p>
<div class="check-btn-group">
<button class="check-btn yes" onclick="finishCheck(true)">âœ… æ˜¯ï¼Œæˆ‘å¾ˆæ¸…æ¥š</button>
<button class="check-btn no" onclick="finishCheck(false)">âŒ å¦ï¼Œä¸å¤ªç¢ºå®š</button>
</div>
</div>

<div id="step-result" class="step">
<div id="final-message">
<h2>ğŸ”„ æ­£åœ¨ç”Ÿæˆåˆ†æçµæœ...</h2>
<p>è«‹ç¨å€™...</p>
</div>
<div id="analysis-content"></div>
</div>

</div>

<script>
/* ===== 1. è¨­å®šèˆ‡é¡Œåº« ===== */
// ğŸ”´ è«‹å‹™å¿…ç¢ºèªé€™è£¡æ›æˆä½ çš„ Google Script ç¶²å€
const scriptURL = "https://script.google.com/macros/s/AKfycbwNNc9BZ0AJzTGGYK4cnqAsuA78FtWMuuVoJMmn4hZpOSWuVCy0N6eLyPk-h414ZkJD/exec";

const RANK_WEIGHTS = [4,3,2,1];
const TAG_MAP = {
  self_reserve: "è‡ªç•™/å½ˆæ€§",
  risk_transfer: "è½‰å«/è¦åŠƒ",
  medical: "é†«ç™‚/ç•¶ä¸‹",
  critical: "é‡å¤§/åº•ç·š",
  life: "ç”Ÿæ´»/è²¬ä»»",
  care: "é•·ç…§/å¤±èƒ½"
};

// ã€è‡ªæˆ‘è¦åŠƒã€‘ç²¾ç°¡ 6 é¡Œ
const questionsSelf = [
  {
    id: "A1", cat: "ã€ç”Ÿæ´»æ„Ÿå—ã€‘",
    title: "ç•¶ç”Ÿæ´»å‡ºç¾è®ŠåŒ–æ™‚ï¼Œä½ é€šå¸¸æœ€åœ¨æ„çš„æ˜¯ï¼Ÿ",
    options: [
      { text: "èƒ½ä¸èƒ½è‡ªå·±åšæ±ºå®šã€ä¸è¢«å¡ä½", tag: "self_reserve" },
      { text: "äº‹æƒ…æœ‰æ²’æœ‰è¢«åˆ†é–‹è™•ç†ï¼Œä¸æœƒå…¨éƒ¨æ“ åœ¨ä¸€èµ·", tag: "risk_transfer" },
      { text: "ç•¶ä¸‹éœ€è¦çš„äº‹æƒ…ï¼Œæœ‰æ²’æœ‰è³‡æºèƒ½é¦¬ä¸Šç”¨", tag: "medical" },
      { text: "æ•´é«”ç”Ÿæ´»ç¯€å¥æœƒä¸æœƒè¢«æ‰“äº‚å¤ªå¤š", tag: "life" }
    ]
  },
  {
    id: "A2", cat: "ã€å®‰å¿ƒä¾†æºã€‘",
    title: "ä»€éº¼æƒ…æ³ï¼Œæœƒè®“ä½ å¿ƒè£¡æ¯”è¼ƒæœ‰åº•ï¼Ÿ",
    options: [
      { text: "æ‰‹ä¸Šæœ‰ä¸€ç­†å¯ä»¥è‡ªç”±é‹ç”¨çš„è³‡æº", tag: "self_reserve" },
      { text: "ä¸åŒç‹€æ³ï¼Œå„è‡ªæœ‰å®‰æ’", tag: "risk_transfer" },
      { text: "éœ€è¦çš„æ™‚å€™ï¼Œä¸ç”¨å†ç…©æƒ±æ€éº¼è™•ç†", tag: "medical" },
      { text: "é‡è¦äº‹æƒ…è‡³å°‘æœ‰åŸºæœ¬æº–å‚™", tag: "critical" }
    ]
  },
  {
    id: "A3", cat: "ã€åšæº–å‚™çš„æ–¹å¼ã€‘",
    title: "å¦‚æœè¦ç‚ºæœªä¾†åšæº–å‚™ï¼Œä½ æ¯”è¼ƒåå¥½ï¼Ÿ",
    options: [
      { text: "æ…¢æ…¢ç´¯ç©ï¼Œç­‰éœ€è¦æ™‚ä¸€æ¬¡ç”¨", tag: "self_reserve" },
      { text: "åˆ†æˆä¸åŒç”¨é€”ï¼Œå„è‡ªå®‰æ’", tag: "risk_transfer" },
      { text: "å…ˆé¡§å¸¸æœƒç”¨åˆ°çš„éƒ¨åˆ†", tag: "medical" },
      { text: "é‡è¦çš„äº‹æƒ…å…ˆæœ‰åº•ç·š", tag: "critical" }
    ]
  },
  {
    id: "A4", cat: "ã€æŒæ§æ„Ÿã€‘",
    title: "ä¸‹é¢å“ªä¸€ç¨®æè¿°ï¼Œæ¯”è¼ƒåƒä½ ï¼Ÿ",
    options: [
      { text: "æˆ‘æ¯”è¼ƒç›¸ä¿¡è‡ªå·±è‡¨å ´åˆ¤æ–·", tag: "self_reserve" },
      { text: "æˆ‘å–œæ­¡äº‹æƒ…äº‹å…ˆåˆ†å¥½é¡å‹", tag: "risk_transfer" },
      { text: "æˆ‘é‡è¦–å¯¦éš›ç”¨å¾—åˆ°çš„å®‰æ’", tag: "medical" },
      { text: "æˆ‘å¸Œæœ›é—œéµæ™‚åˆ»ä¸æœƒå‡ºå•é¡Œ", tag: "critical" }
    ]
  },
  {
    id: "A5", cat: "ã€é¢å°ä¸ç¢ºå®šã€‘",
    title: "é‡åˆ°ä¸ç¢ºå®šçš„æƒ…æ³ï¼Œä½ æ¯”è¼ƒå‚¾å‘ï¼Ÿ",
    options: [
      { text: "å…ˆç•™ç©ºé–“ï¼Œä¹‹å¾Œå†æ±ºå®šæ€éº¼åš", tag: "self_reserve" },
      { text: "äº‹å…ˆåˆ†æ•£ï¼Œæ¸›å°‘å–®ä¸€å£“åŠ›", tag: "risk_transfer" },
      { text: "ç•¶ä¸‹å…ˆè™•ç†æœ€æ€¥çš„éƒ¨åˆ†", tag: "medical" },
      { text: "ç¢ºä¿ä¸æœƒå‡ºç¾æœ€å£ç‹€æ³", tag: "critical" }
    ]
  },
  {
    id: "A6", cat: "ã€åƒ¹å€¼å–å‘ã€‘",
    title: "ä»¥ä¸‹å“ªä¸€å€‹æœ€ç¬¦åˆä½ çš„æƒ³æ³•ï¼Ÿ",
    options: [
      { text: "éŒ¢åœ¨è‡ªå·±æ‰‹ä¸Šï¼Œå½ˆæ€§æœ€å¤§", tag: "self_reserve" },
      { text: "ç”¨é€”åˆ†é–‹ï¼Œå¿ƒç†æ¯”è¼ƒä¸ç´¯", tag: "risk_transfer" },
      { text: "å¯¦ç”¨æœ€é‡è¦ï¼Œä¸ç”¨æƒ³å¤ªå¤š", tag: "medical" },
      { text: "æœ‰æº–å‚™ï¼Œå¿ƒè£¡æ¯”è¼ƒç©©", tag: "critical" }
    ]
  }
];

// ã€å®¶äººè¦åŠƒã€‘ç²¾ç°¡ 4 é¡Œ
const questionsFamily = [
  {
    id: "B1", cat: "ã€é—œæ–¼èº«é‚Šçš„äººã€‘",
    title: "å¦‚æœèº«é‚Šçš„äººé‡åˆ°ç‹€æ³ï¼Œä½ æ¯”è¼ƒåœ¨æ„ï¼Ÿ",
    options: [
      { text: "è‡ªå·±èƒ½ä¸èƒ½é¦¬ä¸Šåšå‡ºæ±ºå®š", tag: "self_reserve" },
      { text: "äº‹æƒ…æœ‰æ²’æœ‰è¢«åˆ†é–‹è™•ç†", tag: "risk_transfer" },
      { text: "å¯¦éš›éœ€è¦èƒ½ä¸èƒ½å³æ™‚è£œä¸Š", tag: "medical" },
      { text: "æ•´é«”ç”Ÿæ´»ä¸è¦è¢«æ‹–å®", tag: "life" }
    ]
  },
  {
    id: "B2", cat: "ã€ä½ çš„è§’è‰²ã€‘",
    title: "åœ¨é‡è¦æ™‚åˆ»ï¼Œä½ å¸Œæœ›è‡ªå·±æ˜¯ï¼Ÿ",
    options: [
      { text: "æœ‰è³‡æºåœ¨æ‰‹ï¼Œå¯ä»¥è‡¨å ´èª¿åº¦", tag: "self_reserve" },
      { text: "æ¯ä»¶äº‹éƒ½æœ‰å°æ‡‰å®‰æ’", tag: "risk_transfer" },
      { text: "å…ˆæŠŠå¯¦éš›éœ€æ±‚é¡§å¥½", tag: "medical" },
      { text: "è‡³å°‘æœ‰åŸºæœ¬åº•ç·š", tag: "critical" }
    ]
  },
  {
    id: "B3", cat: "ã€ç›¸è™•æ„Ÿå—ã€‘",
    title: "ä½ è¦ºå¾—å“ªä¸€ç¨®ç‹€æ…‹æ¯”è¼ƒèˆ’æœï¼Ÿ",
    options: [
      { text: "ä¸ç”¨è¢«é™åˆ¶ï¼Œç”¨è‡ªå·±çš„æ–¹å¼è™•ç†", tag: "self_reserve" },
      { text: "äº‹æƒ…åˆ†æ¸…æ¥šï¼Œä¸æœƒäº’ç›¸å½±éŸ¿", tag: "risk_transfer" },
      { text: "éœ€è¦çš„æ™‚å€™æœ‰äººèƒ½æ”¯æ´", tag: "medical" },
      { text: "é‡è¦äº‹æƒ…æœ‰å®‰æ’å¥½", tag: "critical" }
    ]
  },
  {
    id: "B4", cat: "ã€ä½ çš„åº•ç·šã€‘",
    title: "ä»¥ä¸‹å“ªä¸€ä»¶äº‹ï¼Œä½ æœ€ä¸å¸Œæœ›ç™¼ç”Ÿï¼Ÿ",
    options: [
      { text: "æ‰‹ä¸Šæ²’è³‡æºï¼Œåªèƒ½è¢«å‹•æ‡‰ä»˜", tag: "self_reserve" },
      { text: "æ‰€æœ‰äº‹æƒ…æ“ åœ¨ä¸€èµ·è™•ç†", tag: "risk_transfer" },
      { text: "è©²è™•ç†çš„äº‹æƒ…è¢«æ‹–å»¶", tag: "medical" },
      { text: "é—œéµæ™‚åˆ»å®Œå…¨æ²’æº–å‚™", tag: "critical" }
    ]
  }
];

/* ===== 2. æ ¸å¿ƒé‚è¼¯ ===== */
let currentMode="", currentQueue=[], answers=[], currentIndex=0, currentRank=[];
let totalQuestions=0, finishedQuestions=0;

function selectTarget(mode){
  const name=document.getElementById("clientName").value.trim();
  const dob=document.getElementById("clientDob").value.trim();
  const job=document.getElementById("clientJob").value.trim();
  const contact=document.getElementById("clientContact").value.trim();
  const sex=[...document.getElementsByName("clientSex")].find(x=>x.checked)?.value;
  
  if(!name||!dob||!job||!contact||!sex){alert("è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼Œä»¥ä¾¿æˆ‘å€‘æä¾›ç²¾æº–åˆ†æï¼");return;}
  
  currentMode=mode;
  currentQueue=(mode==="family")?questionsFamily:questionsSelf;
  totalQuestions=(mode==="both")?(questionsSelf.length+questionsFamily.length):currentQueue.length;
  
  document.getElementById("step-intro").classList.remove("active");
  document.getElementById("step-question").classList.add("active");
  loadQuestion();
}

function loadQuestion(){
  if(currentIndex>=currentQueue.length){handleQueueFinish();return;}
  currentRank=[];
  const q=currentQueue[currentIndex];
  document.getElementById("q-category").innerText=q.cat;
  document.getElementById("q-text").innerText=q.title;
  document.getElementById("progress").style.width=(finishedQuestions/totalQuestions*100)+"%";
  renderOptions();
}

function renderOptions(){
  const q=currentQueue[currentIndex];
  const pool=document.getElementById("q-options");pool.innerHTML="";
  q.options.forEach((o,i)=>{
    const idx=currentRank.indexOf(i);
    const div=document.createElement("div");
    div.className="option-card"+(idx>-1?" selected":"");
    div.onclick=()=>toggleOption(i);
    div.innerHTML=`<div class="rank-box">${idx>-1?idx+1:""}</div><div class="option-text">${o.text}</div>`;
    pool.appendChild(div);
  });
  const btn=document.getElementById("next-btn");
  btn.classList.toggle("ready",currentRank.length===4);
}

function toggleOption(i){
  const idx=currentRank.indexOf(i);
  if(idx>-1)currentRank.splice(idx,1);
  else if(currentRank.length<4)currentRank.push(i);
  renderOptions();
}
function resetCurrentRank(){currentRank=[];renderOptions();}

function nextQuestion(){
  if(currentRank.length<4)return;
  const q=currentQueue[currentIndex];
  answers.push({
    mode:currentQueue===questionsSelf?"self":"family",
    title:q.title,
    rankedTags:currentRank.map(i=>q.options[i].tag)
  });
  currentIndex++;finishedQuestions++;loadQuestion();
}

function handleQueueFinish(){
  if(currentMode==="both" && currentQueue===questionsSelf){
    alert("ç¬¬ä¸€éšæ®µå®Œæˆï¼æ¥ä¸‹ä¾†é€²å…¥å®¶äººè¦åŠƒéƒ¨åˆ†ã€‚");
    currentQueue=questionsFamily;currentIndex=0;loadQuestion();
  }else{
    document.getElementById("step-question").classList.remove("active");
    document.getElementById("step-check").classList.add("active");
  }
}

function finishCheck(isKnown){
  document.getElementById("step-check").classList.remove("active");
  document.getElementById("step-result").classList.add("active");

  const name = document.getElementById("clientName").value;
  const dob = document.getElementById("clientDob").value;
  const job = document.getElementById("clientJob").value;
  const contact = document.getElementById("clientContact").value;
  const sex = [...document.getElementsByName("clientSex")].find(x=>x.checked)?.value;

  // è¨ˆç®—åˆ†æ•¸
  let scores={self:{}, family:{}};
  // åˆå§‹åŒ–
  ["self_reserve","risk_transfer","medical","critical","life","care","accident"].forEach(k=>{
      scores.self[k]=0; scores.family[k]=0;
  });

  // è¨ˆç®—æ¯å€‹ Tag çš„ç¸½åˆ†
  answers.forEach(a=>a.rankedTags.forEach((t,i)=>{
      if(scores[a.mode][t] !== undefined) {
          scores[a.mode][t] += RANK_WEIGHTS[i];
      }
  }));

  // === ğŸ”¥ é¡å‹åˆ¤å®šæ¼”ç®—æ³• ğŸ”¥ ===
  // è¨ˆç®—ã€Œè‡ªç•™ (self_reserve)ã€çš„å¹³å‡æ’åºå¼·åº¦
  // å¦‚æœ self_reserve ç¶“å¸¸æ’ç¬¬ 1 (4åˆ†) æˆ–ç¬¬ 2 (3åˆ†) -> é«˜åº¦è‡ªç•™
  // å¦‚æœ self_reserve ç¶“å¸¸æ’ç¬¬ 4 (1åˆ†) -> åˆ†æ•£å®‰æ’
  
  let selfReserveTotal = scores.self.self_reserve + scores.family.self_reserve;
  let totalQs = answers.length;
  let avgSelfScore = totalQs > 0 ? (selfReserveTotal / totalQs) : 0; 
  
  let typeTitle = "";
  let typeClass = "";
  let typeHTML = "";

  if(avgSelfScore >= 2.8) { 
      // å¹³å‡åœ¨ 1~2 åä¹‹é–“ -> é«˜åº¦è‡ªç•™
      typeTitle = "ğŸŸ¦ çµæœä¸€ï½œé«˜åº¦è‡ªç•™å‹";
      typeClass = "result-type-1";
      typeHTML = `
        <span class="result-title" style="color:#2980b9">${typeTitle}</span>
        <div class="result-desc">
            <b>ä½ çš„é¢¨æ ¼æ˜¯ï¼šæŠŠé¸æ“‡æ¬Šç•™åœ¨è‡ªå·±æ‰‹ä¸Š</b><br>
            ä½ ä¸¦ä¸æ˜¯å¿½ç•¥ä¸ç¢ºå®šæ€§ï¼Œè€Œæ˜¯æ›´ç›¸ä¿¡ï¼š<br>
            ğŸ‘‰ ã€Œè³‡æºé›†ä¸­åœ¨è‡ªå·±æ‰‹è£¡ï¼Œè‡¨å ´åˆ¤æ–·æœ€é‡è¦ã€<br><br>
            <b>ä½ åœ¨æ„çš„æ˜¯ï¼š</b>
            <ul class="result-list">
                <li>è‡ªç”±åº¦èˆ‡æŒæ§æ„Ÿ</li>
                <li>ä¸è¢«ç”¨é€”æˆ–è¦å‰‡é™åˆ¶</li>
                <li>éœ€è¦æ™‚å¯ä»¥ä¸€æ¬¡åšæ±ºå®š</li>
            </ul>
            <p style="text-align:left;font-size:0.9em;color:#777">é©åˆï¼šå°è‡ªå·±åˆ¤æ–·æœ‰ä¿¡å¿ƒã€ç¾é‡‘æµç®¡ç†èƒ½åŠ›ä¸éŒ¯ã€ä¸å–œæ­¡è¢«ç¶ä½çš„äººã€‚</p>
        </div>`;
  } else if (avgSelfScore <= 2.2) {
      // å¹³å‡åœ¨ 3~4 åä¹‹é–“ -> åˆ†æ•£å®‰æ’ (ä¿¡è³´ç³»çµ±)
      typeTitle = "ğŸŸ¨ çµæœä¸‰ï½œåˆ†æ•£å®‰æ’å‹";
      typeClass = "result-type-3";
      typeHTML = `
        <span class="result-title" style="color:#f39c12">${typeTitle}</span>
        <div class="result-desc">
            <b>ä½ çš„é¢¨æ ¼æ˜¯ï¼šäº‹å…ˆåˆ†é¡ï¼Œå¿ƒè£¡æ¯”è¼ƒä¸ç´¯</b><br>
            ä½ æ¯”è¼ƒå®‰å¿ƒçš„æ˜¯ï¼š<br>
            ğŸ‘‰ ã€Œä¸åŒç‹€æ³å„è‡ªæœ‰æº–å‚™ï¼Œä¸ç”¨è‡¨æ™‚æƒ³ã€<br><br>
            <b>ä½ åœ¨æ„çš„æ˜¯ï¼š</b>
            <ul class="result-list">
                <li>å£“åŠ›ä¸è¦é›†ä¸­</li>
                <li>æ¯ä»¶äº‹éƒ½æœ‰å°æ‡‰æ–¹å¼</li>
                <li>ç”Ÿæ´»ç¯€å¥ä¸è¢«æ‰“äº‚</li>
            </ul>
            <p style="text-align:left;font-size:0.9em;color:#777">é©åˆï¼šå–œæ­¡æ¸…æ¥šè¦åŠƒã€ä¸æƒ³è‡¨å ´æ‰¿æ“”å¤ªå¤šè®Šæ•¸çš„äººã€‚</p>
        </div>`;
  } else {
      // ä»‹æ–¼ä¸­é–“ -> æ··åˆå½ˆæ€§
      typeTitle = "ğŸŸ© çµæœäºŒï½œæ··åˆå½ˆæ€§å‹";
      typeClass = "result-type-2";
      typeHTML = `
        <span class="result-title" style="color:#27ae60">${typeTitle}</span>
        <div class="result-desc">
            <b>ä½ çš„é¢¨æ ¼æ˜¯ï¼šé‡è¦çš„åˆ†é–‹ï¼Œå…¶é¤˜ç•™å½ˆæ€§</b><br>
            ä½ ä¸å¤ªèµ°æ¥µç«¯ï¼Œè€Œæ˜¯åå¥½ï¼š<br>
            ğŸ‘‰ ã€Œé—œéµäº‹æƒ…å…ˆé¡§å¥½ï¼Œä¿ç•™èª¿æ•´ç©ºé–“ã€<br><br>
            <b>ä½ åœ¨æ„çš„æ˜¯ï¼š</b>
            <ul class="result-list">
                <li>ç”Ÿæ´»ç©©å®šåº¦</li>
                <li>å½ˆæ€§èˆ‡å®‰å…¨æ„Ÿä¹‹é–“çš„å¹³è¡¡</li>
                <li>ä¸è®“å–®ä¸€äº‹ä»¶å½±éŸ¿å…¨éƒ¨</li>
            </ul>
            <p style="text-align:left;font-size:0.9em;color:#777">å¸¸è¦‹æ–¼ï¼šé‡è¦–ç”Ÿæ´»å“è³ªã€ç¿’æ…£åˆ†å±¤å®‰æ’äº‹æƒ…çš„äººã€‚</p>
        </div>`;
  }

  // ç”Ÿæˆå¾Œå°å ±å‘Š
  function sort(o){return Object.entries(o).sort((a,b)=>b[1]-a[1]);}
  const sortedSelf=sort(scores.self);
  const sortedFamily=sort(scores.family);

  let report = `ã€ğŸ§‘ å®¢æˆ¶æª”æ¡ˆã€‘\n`;
  report += `å§“åï¼š${name} (${sex})\n`;
  report += `ç”Ÿæ—¥ï¼š${dob}\n`;
  report += `è·æ¥­ï¼š${job}\n`;
  report += `è¯çµ¡ï¼š${contact}\n`;
  report += `ä¿å–®å¥æª¢æ„é¡˜ï¼š${isKnown ? "æ¸…æ¥šæ—¢æœ‰ä¿éšœ" : "âš ï¸ ä¸æ¸…æ¥š (å»ºè­°å¥æª¢)"}\n`;
  report += `------------------------\n`;
  
  report += `ã€ğŸ§  é¢¨æ ¼åˆ†æã€‘\n${typeTitle}\n(è‡ªç•™åˆ†æ•¸å¹³å‡: ${avgSelfScore.toFixed(1)})\n\n`;

  report += `ã€ğŸ“Š è©³ç´°æ¬Šé‡æ’åã€‘\n`;
  if(currentMode === "self" || currentMode === "both"){
      report += `[è‡ªæˆ‘è¦åŠƒ]\n` + sortedSelf.filter(s=>s[1]>0).map(s=>`ğŸ”¹${TAG_MAP[s[0]] || s[0]}: ${s[1]}åˆ†`).join("\n") + "\n\n";
  }
  if(currentMode === "family" || currentMode === "both"){
      report += `[å®¶äººè¦åŠƒ]\n` + sortedFamily.filter(s=>s[1]>0).map(s=>`ğŸ”¸${TAG_MAP[s[0]] || s[0]}: ${s[1]}åˆ†`).join("\n");
  }

  // 4. å‚³é€
  fetch(scriptURL, {
    method: "POST",
    mode: "no-cors", 
    headers: {"Content-Type": "text/plain"},
    body: JSON.stringify({
        name: name,
        mode: currentMode,
        analysis: report
    })
  })
  .then(() => {
      document.getElementById("final-message").style.display = "none"; // éš±è—è®€å–ä¸­
      let resultContainer = document.getElementById("analysis-content");
      
      let html = `
        <div style="text-align:center; margin-bottom:20px;">
            <h2 style="color: #27ae60; margin:0;">âœ… åˆ†æå®Œæˆ</h2>
            <p>æ„Ÿè¬æ‚¨çš„å¡«å¯«ï¼ä»¥ä¸‹æ˜¯æ‚¨çš„åˆ†æçµæœï¼š</p>
        </div>
        
        <div class="result-card ${typeClass}">
            ${typeHTML}
        </div>
      `;

      if(!isKnown) {
          html += `
            <div style="background:#fff3cd;color:#856404;padding:15px;border-radius:8px;margin-top:20px;text-align:center;">
                <strong>ğŸ’¡ è²¼å¿ƒæé†’</strong><br>
                å»ºè­°é ç´„ä¿å–®å¥æª¢ï¼Œé¿å…é‡è¤‡æŠ•ä¿ï¼
            </div>
          `;
      }
      
      html += `<button class="nav-btn ready" onclick="location.reload()" style="margin-top:30px">é—œé–‰</button>`;
      
      resultContainer.innerHTML = html;
  })
  .catch(() => alert("å‚³é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯"));
}
</script>
</body>
</html>
