<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ–¹ä½ä¿éšªéœ€æ±‚æ¬Šé‡åˆ†æ</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
            --selected: #27ae60;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background-color: var(--card-bg);
            width: 100%;
            max-width: 600px;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            position: relative;
        }

        h1, h2, h3 { text-align: center; color: var(--primary); margin-bottom: 15px; }
        p { text-align: center; color: #666; margin-bottom: 25px; line-height: 1.6; }

        .progress-bar {
            height: 6px;
            background: #eee;
            border-radius: 3px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s ease;
        }

        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.9em; }
        input[type="text"], input[type="tel"] {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 1px solid #ddd; border-radius: 6px; font-size: 16px;
            box-sizing: border-box; background: #fff;
        }

        /* æ™ºæ…§å¡«ç©ºé¸é …æ¨£å¼ */
        .option-pool { display: flex; flex-direction: column; gap: 12px; }
        .option-card {
            background: white; border: 2px solid #e0e0e0; padding: 15px;
            border-radius: 10px; cursor: pointer; display: flex;
            align-items: center; transition: all 0.2s ease;
        }
        .option-card:hover { border-color: #bbb; background-color: #f9f9f9; }
        .option-card.selected { border-color: var(--selected); background-color: #f0fff4; }
        
        .rank-box {
            width: 32px; height: 32px; border: 2px solid #ccc; border-radius: 6px;
            margin-right: 15px; display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 1.1em; color: white; background: white;
            transition: all 0.2s; flex-shrink: 0;
        }
        .option-card.selected .rank-box { background-color: var(--selected); border-color: var(--selected); }
        .option-text { font-size: 1rem; color: #333; line-height: 1.4; }

        /* é€šç”¨æŒ‰éˆ• */
        .nav-btn {
            background-color: var(--primary); color: white; border: none;
            padding: 12px 30px; border-radius: 6px; font-size: 16px;
            cursor: pointer; width: 100%; margin-top: 20px;
            opacity: 0.5; pointer-events: none; transition: all 0.3s;
        }
        .nav-btn.ready { opacity: 1; pointer-events: auto; background-color: var(--accent); }

        .radio-group { display: flex; gap: 20px; margin-bottom: 15px; }
        .radio-label { display: flex; align-items: center; cursor: pointer; background: #fff; padding: 10px 20px; border: 1px solid #ddd; border-radius: 6px; width: 100%; }
        .radio-label input { margin-right: 8px; }

        .step { display: none; animation: fadeIn 0.4s; }
        .step.active { display: block; }

        /* ä¿å–®å¥æª¢ Modal */
        #check-modal { text-align: center; }
        .check-btn-group { display: flex; gap: 15px; margin-top: 20px; }
        .check-btn { flex: 1; padding: 15px; border-radius: 8px; border: 2px solid #ddd; background: white; cursor: pointer; font-weight: bold; }
        .check-btn.yes { border-color: var(--selected); color: var(--selected); }
        .check-btn.no { border-color: var(--accent); color: var(--accent); }
        .check-btn:hover { background: #f0f0f0; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #loading-spinner { display: none; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>

    <div id="step-intro" class="step active">
        <h2>ğŸ“Š å…¨æ–¹ä½ä¿éšªæ¬Šé‡åˆ†æ</h2>
        <p>é€™ä»½å•å·å°‡å”åŠ©æˆ‘å€‘é‡æ¸…<br>æ‚¨å°ã€Œçµ‚èº«/å®šæœŸã€é†«ç™‚/æ„å¤–ã€ç­‰å„é …ä¿éšœçš„å„ªå…ˆé †åºã€‚</p>
        
        <label>å§“å</label>
        <input type="text" id="clientName" placeholder="è«‹è¼¸å…¥å§“å">
        
        <label>æ€§åˆ¥</label>
        <div class="radio-group">
            <label class="radio-label"><input type="radio" name="clientSex" value="ç”·"> ç”·</label>
            <label class="radio-label"><input type="radio" name="clientSex" value="å¥³"> å¥³</label>
        </div>

        <label>ç”Ÿæ—¥ (å¦‚ï¼š19860101)</label>
        <input type="tel" id="clientDob" placeholder="YYYYMMDD" maxlength="8">

        <label>è·æ¥­ (è«‹å¡«å¯«å®Œæ•´)</label>
        <input type="text" id="clientJob" placeholder="ä¾‹å¦‚ï¼šè»Ÿé«”å·¥ç¨‹å¸«">

        <label>è¯çµ¡æ–¹å¼ (æ‰‹æ©Ÿ / Line ID)</label>
        <input type="text" id="clientContact" placeholder="09xxxxxxxx æˆ– Line ID">
        
        <div style="border-top: 1px dashed #ccc; margin: 25px 0;"></div>

        <label style="color: var(--accent); font-size: 1.1em;">è¦åŠƒå°è±¡</label>
        <div class="option-pool">
            <button class="option-card" style="justify-content:center; font-weight:bold;" onclick="selectTarget('self')">A. åªæœ‰æˆ‘è‡ªå·±</button>
            <button class="option-card" style="justify-content:center; font-weight:bold;" onclick="selectTarget('family')">B. åªæœ‰å®¶äºº</button>
            <button class="option-card" style="justify-content:center; font-weight:bold;" onclick="selectTarget('both')">C. å…©è€…éƒ½è¦</button>
        </div>
    </div>

    <div id="step-question" class="step">
        <h4 id="q-category" style="text-align:center; color:#999; margin:0;">é¡åˆ¥</h4>
        <h3 id="q-text" style="margin-top:5px;">å•é¡Œæ¨™é¡Œ</h3>
        <p style="font-size:0.9em; margin-bottom:15px; color:#e74c3c;">
            è«‹ä¾åºé»æ“Šé¸é …ï¼Œæ¨™ç¤ºå‡º 1ã€2ã€3ã€4 å
        </p>
        
        <div class="option-pool" id="q-options">
            </div>

        <button id="next-btn" class="nav-btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â”</button>
        <p style="font-size:0.8em; margin-top:10px; color:#999; cursor:pointer;" onclick="resetCurrentRank()">â†» é»æ­¤é‡æ–°æ’åºæœ¬é¡Œ</p>
    </div>

    <div id="step-check" class="step">
        <div id="check-modal">
            <h2 style="color:var(--primary);">ğŸ›¡ï¸ æœ€å¾Œç¢ºèª</h2>
            <p style="font-size:1.2em; font-weight:bold;">è«‹å•æ‚¨æ¸…æ¥šè‡ªå·±ç›®å‰èº«ä¸Šæ—¢æœ‰çš„<br>ã€Œæ‰€æœ‰ä¿éšœå…§å®¹ã€å—ï¼Ÿ</p>
            <p style="font-size:0.9em; color:#666;">(åŒ…å«å…¬å¸åœ˜ä¿ã€å°æ™‚å€™çˆ¶æ¯è²·çš„ä¿å–®...ç­‰)</p>
            
            <div class="check-btn-group">
                <button class="check-btn yes" onclick="finishCheck(true)">âœ… æ˜¯ï¼Œæˆ‘å¾ˆæ¸…æ¥š</button>
                <button class="check-btn no" onclick="finishCheck(false)">âŒ å¦ï¼Œä¸å¤ªç¢ºå®š</button>
            </div>
        </div>
    </div>

    <div id="step-result" class="step">
        <div id="final-message">
            <h2>ğŸ”„ æ­£åœ¨ç”Ÿæˆåˆ†æå ±å‘Š...</h2>
            <p>åŒ…å«éšªç¨®æ¬Šé‡ã€è³‡é‡‘åå¥½èˆ‡å¥æª¢å»ºè­°...</p>
            <div id="loading-spinner">â³ ä¸Šå‚³ä¸­...</div>
        </div>
    </div>

</div>

<script>
    // ğŸ”´ ä½ çš„ Google Script ç¶²å€
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwNNc9BZ0AJzTGGYK4cnqAsuA78FtWMuuVoJMmn4hZpOSWuVCy0N6eLyPk-h414ZkJD/exec';

    /* === æ¨™ç±¤ç³»çµ±å°ç…§ (Mapping) ===
       - å£½éšª/å®šæœŸ: Life_Term
       - å£½éšª/çµ‚èº«: Life_Whole
       - é†«ç™‚/æ—¥é¡: Med_Daily
       - é†«ç™‚/æ‰‹è¡“: Med_Surg
       - é‡å¤§/ç™Œç—‡: CI_Cancer
       - é•·ç…§/å¤±èƒ½: LTC_Disability
       - æ„å¤–: Accident
       - å„²è“„/é‚„æœ¬: Saving_MoneyBack
    */

    const questionsSelf = [
        { 
            cat: "ã€è‡ªæˆ‘ã€‘ç”Ÿå­˜é¢¨éšª", 
            q: "å¦‚æœä¸å¹¸ç™¼ç”Ÿäº‹æ•…ï¼Œä½ æœ€æ“”å¿ƒç„¡æ³•è§£æ±ºçš„å•é¡Œæ˜¯ï¼Ÿ", 
            opts: [
                { text: "é•·æœŸè‡¥åºŠéœ€äººç…§é¡§ (é•·ç…§/å¤±èƒ½)", tag: "é•·ç…§/å¤±èƒ½" },
                { text: "æ€¥éœ€ä¸€å¤§ç­†éŒ¢æ²»ç™‚é‡ç—‡ (é‡å¤§å‚·ç—…)", tag: "é‡å¤§/ç™Œç—‡" },
                { text: "ä½é™¢æ‰‹è¡“èŠ±è²»é«˜ (é†«ç™‚å¯¦æ”¯)", tag: "é†«ç™‚/æ‰‹è¡“" },
                { text: "èµ°å¾—å¤ªæ—©ï¼Œè²¬ä»»æœªäº† (å£½éšª)", tag: "å£½éšª/å®šæœŸ" }
            ]
        },
        { 
            cat: "ã€è‡ªæˆ‘ã€‘é†«ç™‚å“è³ª", 
            q: "å‡è¨­ç”Ÿç—…ä½é™¢ï¼Œä½ æœ€åœ¨æ„çš„å“è³ªæ˜¯ï¼Ÿ", 
            opts: [
                { text: "ä¸ç”¨å®¶äººè¼ªç­ï¼Œæœ‰éŒ¢è«‹çœ‹è­·", tag: "é†«ç™‚/æ—¥é¡" },
                { text: "ä½¿ç”¨æœ€å¥½çš„è‡ªè²»é†«æ/é”æ–‡è¥¿", tag: "é†«ç™‚/æ‰‹è¡“" },
                { text: "å®‰å¿ƒä¼‘é¤Šï¼Œä¸ç”¨æ“”å¿ƒè–ªæ°´æ–·ç‚Š", tag: "é•·ç…§/å¤±èƒ½" },
                { text: "æ„å¤–å—å‚·å¾©å¥æœ‰è£œè²¼", tag: "æ„å¤–" }
            ]
        },
        { 
            cat: "ã€è‡ªæˆ‘ã€‘é ç®—å„ªå…ˆ", 
            q: "å¦‚æœé ç®—æœ‰é™ï¼Œä½ å¸Œæœ›ä¿è²»å„ªå…ˆèŠ±åœ¨ï¼Ÿ", 
            opts: [
                { text: "è§£æ±ºã€Œèµ°ä¸æ‰ã€çš„é•·æœŸç…§é¡§è²»", tag: "é•·ç…§/å¤±èƒ½" },
                { text: "è§£æ±ºã€Œç—…å¤ªä¹…ã€çš„é«˜é¡è‡ªè²»", tag: "é†«ç™‚/æ‰‹è¡“" },
                { text: "è§£æ±ºã€Œç—…å¤ªé‡ã€çš„ä¸€æ¬¡é‡‘", tag: "é‡å¤§/ç™Œç—‡" },
                { text: "è§£æ±ºã€Œçªç™¼æ„å¤–ã€çš„ç›¸é—œè²»ç”¨", tag: "æ„å¤–" }
            ]
        },
        { 
            cat: "ã€è‡ªæˆ‘ã€‘ç†è³ å½¢å¼ (åå¥½)", 
            q: "ä½ æ¯”è¼ƒå–œæ­¡å“ªç¨®ç†è³ æ–¹å¼ï¼Ÿ", 
            opts: [
                { text: "æŒ‰æœˆçµ¦ä»˜ (åƒé ˜è–ªæ°´ä¸€æ¨£)", tag: "ç†è³ _åˆ†æœŸ" },
                { text: "å¯¦å ±å¯¦éŠ· (èŠ±å¤šå°‘è³ å¤šå°‘)", tag: "ç†è³ _å¯¦æ”¯" },
                { text: "ä¸€æ¬¡æ‹¿ä¸€å¤§ç­† (è‡ªç”±é‹ç”¨)", tag: "ç†è³ _ä¸€æ¬¡é‡‘" },
                { text: "å®šé¡çµ¦ä»˜ (ç™¼ç”Ÿå°±è³ å›ºå®šé‡‘é¡)", tag: "ç†è³ _å®šé¡" }
            ]
        },
        { 
            cat: "ã€è‡ªæˆ‘ã€‘è³‡é‡‘è§€å¿µ (éšªç¨®å±¬æ€§)", 
            q: "å°æ–¼ä¿è²»èˆ‡ä¿éšœçš„é—œä¿‚ï¼Œä½ çš„çœ‹æ³•æ˜¯ï¼Ÿ", 
            opts: [
                { text: "ä¸€å®šè¦æ‹¿å›æœ¬é‡‘ (çµ‚èº«/é‚„æœ¬)", tag: "åå¥½_çµ‚èº«é‚„æœ¬" },
                { text: "é ç®—ä½ä¿éšœé«˜ï¼Œä¸é‚„æœ¬æ²’é—œä¿‚ (å®šæœŸ)", tag: "åå¥½_å®šæœŸé«˜æ§“æ¡¿" },
                { text: "å¹´è¼•æ™‚ä¿è²»ä¾¿å®œå°±å¥½ (è‡ªç„¶è²»ç‡)", tag: "åå¥½_å®šæœŸé«˜æ§“æ¡¿" },
                { text: "ç¹³è²»20å¹´ä¿éšœçµ‚èº« (å¹³æº–è²»ç‡)", tag: "åå¥½_çµ‚èº«é‚„æœ¬" }
            ]
        },
        { 
            cat: "ã€è‡ªæˆ‘ã€‘ç¼ºå£å¡«è£œ", 
            q: "å¦‚æœçœŸçš„ç„¡æ³•å·¥ä½œäº†ï¼Œä½ å¸Œæœ›ä¿éšªè§£æ±ºï¼Ÿ", 
            opts: [
                { text: "æ¯æœˆçš„ç”Ÿæ´»è²»èˆ‡çœ‹è­·è²»", tag: "é•·ç…§/å¤±èƒ½" },
                { text: "é†«é™¢çš„è‡ªè²»æ‰‹è¡“å–®", tag: "é†«ç™‚/æ‰‹è¡“" },
                { text: "é‚„æ¸…æˆ¿è²¸æˆ–ç•™çµ¦å®¶äºº", tag: "å£½éšª/å®šæœŸ" },
                { text: "ç™Œç—‡æ¨™é¶è—¥ç‰©è²»ç”¨", tag: "é‡å¤§/ç™Œç—‡" }
            ]
        },
        { 
            cat: "ã€è‡ªæˆ‘ã€‘æ„å¤–é¢¨éšª", 
            q: "é‡å°æ„å¤–äº‹æ•…ï¼Œä½ æœ€æ€•ï¼Ÿ", 
            opts: [
                { text: "å¤±èƒ½å°è‡´ç„¡æ³•å·¥ä½œ", tag: "é•·ç…§/å¤±èƒ½" },
                { text: "éª¨æŠ˜/å—å‚·éœ€è¦ä¼‘é¤Š", tag: "æ„å¤–" },
                { text: "æ„å¤–èº«æ•…", tag: "å£½éšª/å®šæœŸ" },
                { text: "å› æ„å¤–å°è‡´çš„é«˜é¡é†«ç™‚è²»", tag: "é†«ç™‚/æ‰‹è¡“" }
            ]
        },
        { 
            cat: "ã€è‡ªæˆ‘ã€‘å£½éšªéœ€æ±‚", 
            q: "å°æ–¼ã€Œèº«æ•…ç†è³ é‡‘ã€(å£½éšª)ï¼Œä½ çš„æƒ³æ³•æ˜¯ï¼Ÿ", 
            opts: [
                { text: "éå¸¸é‡è¦ï¼Œæˆ¿è²¸/å°å­©è²¬ä»»é‡", tag: "å£½éšª/å®šæœŸ" },
                { text: "å¸Œæœ›ç•™ä¸€ç­†éŒ¢ç•¶å‚³æ‰¿ (è³‡ç”¢)", tag: "å£½éšª/çµ‚èº«" },
                { text: "åªéœ€è¦ä¸€é»å–ªè‘¬è²»å°±å¥½", tag: "å£½éšª/å®šæœŸ" },
                { text: "æˆ‘æ¯”è¼ƒé‡è¦–æ´»è‘—çš„æ™‚å€™èƒ½è³ ", tag: "é†«ç™‚/æ‰‹è¡“" }
            ]
        },
        { 
            cat: "ã€è‡ªæˆ‘ã€‘é†«ç™‚ç´°ç¯€", 
            q: "é‡å°ä½é™¢é†«ç™‚ï¼Œä½ æ›´é‡è¦–ï¼Ÿ", 
            opts: [
                { text: "ç—…æˆ¿è²» (æƒ³ä½å–®äººæˆ¿)", tag: "é†«ç™‚/æ—¥é¡" },
                { text: "é›œè²»é¡åº¦ (è—¥ç‰©/é†«æè²´)", tag: "é†«ç™‚/æ‰‹è¡“" },
                { text: "æ‰‹è¡“è²» (é–‹åˆ€è£œè²¼)", tag: "é†«ç™‚/æ‰‹è¡“" },
                { text: "å‡ºé™¢å¾Œçš„ç™‚é¤Šé‡‘", tag: "é†«ç™‚/æ—¥é¡" }
            ]
        },
        { 
            cat: "ã€è‡ªæˆ‘ã€‘æœ€çµ‚æ±ºç­–", 
            q: "æœ€å¾Œï¼Œè‹¥åªèƒ½é¸ä¸€å€‹ã€Œçµ•å°ä¸èƒ½å°‘ã€çš„ä¿éšœï¼Ÿ", 
            opts: [
                { text: "é•·ç…§/å¤±èƒ½ (è§£æ±ºæ´»å¤ªä¹…)", tag: "é•·ç…§/å¤±èƒ½" },
                { text: "å¯¦æ”¯å¯¦ä»˜ (è§£æ±ºç—…å¤ªä¹…)", tag: "é†«ç™‚/æ‰‹è¡“" },
                { text: "é‡å¤§å‚·ç—… (è§£æ±ºç—…å¤ªé‡)", tag: "é‡å¤§/ç™Œç—‡" },
                { text: "æ„å¤–/å£½éšª (è§£æ±ºèµ°å¤ªå¿«)", tag: "æ„å¤–" }
            ]
        }
    ];

    const questionsFamily = [
        // ç‚ºäº†ç¯€çœç¯‡å¹…ï¼Œé‚è¼¯åŒä¸Šï¼Œä½†æ¨™ç±¤æ”¹æˆ Family è¦–è§’
        // å»ºè­°é€™è£¡ä¹Ÿå¡«å…¥ 10 é¡Œé¡ä¼¼ä¸Šé¢çš„ï¼Œä½†èªæ°£æ”¹ç‚ºã€Œå®¶äººã€
        // æˆ‘å…ˆæ”¾å…¥ 3 é¡Œç¯„ä¾‹ï¼Œæ‚¨å¯ä»¥è‡ªè¡Œä¾ç…§ä¸Šé¢çš„æ ¼å¼æ“´å……è‡³ 10 é¡Œ
        { 
            cat: "ã€å®¶äººã€‘ç…§é¡§æ“”æ†‚", 
            q: "ç•¶å®¶äººç”Ÿç—…å€’ä¸‹ï¼Œä½ æœ€æ€•é¢è‡¨ä»€éº¼ç‹€æ³ï¼Ÿ", 
            opts: [
                { text: "éœ€é•·æœŸè‡¥åºŠï¼Œçœ‹è­·è²»ç„¡åº•æ´", tag: "é•·ç…§/å¤±èƒ½" },
                { text: "çªç„¶éœ€è¦å¹¾åè¬çš„æ‰‹è¡“è²»", tag: "é†«ç™‚/æ‰‹è¡“" },
                { text: "ç‚ºäº†ç…§é¡§å®¶äººï¼Œè¢«è¿«è¾­è·", tag: "é†«ç™‚/æ—¥é¡" },
                { text: "ç™Œç—‡æ¨™é¶è—¥ç‰©å¤ªè²´", tag: "é‡å¤§/ç™Œç—‡" }
            ]
        },
        { 
            cat: "ã€å®¶äººã€‘ç†è³ åå¥½", 
            q: "å¹«å®¶äººè¦åŠƒï¼Œä½ åå¥½å“ªç¨®ç†è³ ï¼Ÿ", 
            opts: [
                { text: "æ¯æœˆçµ¦ä»˜ (ä¸ç”¨å…„å¼Ÿåˆ†æ”¤)", tag: "ç†è³ _åˆ†æœŸ" },
                { text: "å¯¦å ±å¯¦éŠ· (ä¸ç”¨æ“”å¿ƒè—¥è²»)", tag: "ç†è³ _å¯¦æ”¯" },
                { text: "ä¸€æ¬¡çµ¦ä»˜ (éˆæ´»é‹ç”¨)", tag: "ç†è³ _ä¸€æ¬¡é‡‘" },
                { text: "çµ‚èº«é‚„æœ¬ (ç•¶ä½œå­˜éŒ¢)", tag: "åå¥½_çµ‚èº«é‚„æœ¬" }
            ]
        },
        { 
            cat: "ã€å®¶äººã€‘é ç®—å–æ¨", 
            q: "å¦‚æœå®¶äººé ç®—æœ‰é™ï¼Œå…ˆè§£æ±ºï¼Ÿ", 
            opts: [
                { text: "é•·æœŸç…§é¡§çš„è²»ç”¨", tag: "é•·ç…§/å¤±èƒ½" },
                { text: "ä½é™¢é†«ç™‚è‡ªè²»", tag: "é†«ç™‚/æ‰‹è¡“" },
                { text: "çªç™¼å¤§ç—…æ€¥ç”¨é‡‘", tag: "é‡å¤§/ç™Œç—‡" },
                { text: "è€äººè·Œå€’æ„å¤–", tag: "æ„å¤–" }
            ]
        }
        // è«‹åœ¨æ­¤è™•ç¹¼çºŒè£œè¶³å®¶äººé¡Œåº«...
    ];


    // === æ ¸å¿ƒé‚è¼¯ ===
    let currentMode = '';
    let currentQueue = [];
    let answers = [];
    let currentIndex = 0;
    let currentRank = []; 

    function selectTarget(mode) {
        // --- ğŸŸ¢ å¼·åŒ–é©—è­‰é‚è¼¯ ---
        const name = document.getElementById('clientName').value.trim();
        const contact = document.getElementById('clientContact').value.trim();
        const job = document.getElementById('clientJob').value.trim();
        const dob = document.getElementById('clientDob').value.trim();
        
        const sexEls = document.getElementsByName('clientSex');
        let sex = ''; for(let el of sexEls) if(el.checked) sex = el.value;

        // 1. å¿…å¡«æª¢æŸ¥
        if (!name || !sex || !contact || !job || !dob) {
            alert("âš ï¸ è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼Œä»¥ä¾¿æˆ‘å€‘æä¾›ç²¾æº–åˆ†æï¼");
            return;
        }

        // 2. æ‰‹æ©Ÿ/Line é©—è­‰ (ç°¡å–®é•·åº¦æª¢æŸ¥)
        if (contact.length < 4) {
             alert("âš ï¸ è«‹è¼¸å…¥æœ‰æ•ˆçš„è¯çµ¡æ–¹å¼ (æ‰‹æ©Ÿæˆ– Line ID)");
             return;
        }

        // 3. è·æ¥­é©—è­‰
        if (job.length < 2) {
            alert("âš ï¸ è«‹è¼¸å…¥å®Œæ•´çš„è·æ¥­åç¨±");
            return;
        }

        currentMode = mode;
        if (mode === 'self' || mode === 'both') currentQueue = questionsSelf;
        else currentQueue = questionsFamily;

        document.getElementById('step-intro').classList.remove('active');
        document.getElementById('step-question').classList.add('active');
        loadQuestion();
    }

    function loadQuestion() {
        if (currentIndex >= currentQueue.length) {
            handleQueueFinish();
            return;
        }

        currentRank = [];
        document.getElementById('next-btn').classList.remove('ready');

        const qData = currentQueue[currentIndex];
        document.getElementById('q-category').innerText = qData.cat;
        document.getElementById('q-text').innerText = (currentIndex+1) + ". " + qData.q;
        
        const pct = (currentIndex / currentQueue.length) * 100;
        document.getElementById('progress').style.width = pct + "%";

        renderOptions();
    }

    function renderOptions() {
        const qData = currentQueue[currentIndex];
        const pool = document.getElementById('q-options');
        pool.innerHTML = '';

        qData.opts.forEach((opt, idx) => {
            let rankIndex = currentRank.indexOf(idx); 
            let rankNum = rankIndex > -1 ? (rankIndex + 1) : "";
            let isSelected = rankIndex > -1;

            let card = document.createElement('div');
            card.className = `option-card ${isSelected ? 'selected' : ''}`;
            card.onclick = () => toggleOption(idx);

            card.innerHTML = `
                <div class="rank-box">${rankNum}</div>
                <div class="option-text">${opt.text}</div>
            `;
            pool.appendChild(card);
        });

        updateNextBtn();
    }

    function toggleOption(idx) {
        let rankIndex = currentRank.indexOf(idx);
        if (rankIndex > -1) {
            currentRank.splice(rankIndex, 1);
        } else {
            if (currentRank.length < 4) {
                currentRank.push(idx);
            }
        }
        renderOptions();
    }

    function resetCurrentRank() {
        currentRank = [];
        renderOptions();
    }

    function updateNextBtn() {
        const nextBtn = document.getElementById('next-btn');
        if (currentRank.length === 4) {
            nextBtn.classList.add('ready');
            nextBtn.innerText = "ä¸‹ä¸€é¡Œ â”";
        } else {
            nextBtn.classList.remove('ready');
            nextBtn.innerText = `è«‹æ’åºå®Œç•¢ (${currentRank.length}/4)`;
        }
    }

    function nextQuestion() {
        if (currentRank.length < 4) return;
        const qData = currentQueue[currentIndex];
        const rankedTags = currentRank.map(idx => qData.opts[idx].tag);
        
        answers.push({ q: qData.q, rankedTags: rankedTags });
        currentIndex++;
        loadQuestion();
    }

    function handleQueueFinish() {
        if (currentMode === 'both' && currentQueue === questionsSelf) {
            alert("ç¬¬ä¸€éšæ®µå®Œæˆï¼æ¥ä¸‹ä¾†é€²å…¥å®¶äººè¦åŠƒéƒ¨åˆ†ã€‚");
            currentQueue = questionsFamily;
            currentIndex = 0;
            loadQuestion();
        } else {
            // ğŸŸ¢ å…¨éƒ¨åšå®Œï¼Œé€²å…¥ä¿å–®å¥æª¢ç¢ºèª
            document.getElementById('step-question').classList.remove('active');
            document.getElementById('step-check').classList.add('active');
        }
    }

    // === ä¿å–®å¥æª¢ç¢ºèª ===
    function finishCheck(isKnown) {
        submitData(isKnown);
    }

    // === ğŸ”¥ å¾Œå°åŠ æ¬Šè¨ˆç®—æ ¸å¿ƒ ===
    function submitData(isKnown) {
        document.getElementById('step-check').classList.remove('active');
        document.getElementById('step-result').classList.add('active');
        document.getElementById('loading-spinner').style.display = 'block';

        const name = document.getElementById('clientName').value;
        const contact = document.getElementById('clientContact').value;
        const job = document.getElementById('clientJob').value;
        const dob = document.getElementById('clientDob').value;
        const sexEls = document.getElementsByName('clientSex');
        let sex = ''; for(let el of sexEls) if(el.checked) sex = el.value;

        // 1. è¨ˆç®—æ¬Šé‡åˆ†æ•¸
        let scores = {}; 
        let prefStructure = {}; // ç´€éŒ„çµæ§‹åå¥½ (å®šæœŸ/çµ‚èº«/åˆ†æœŸ/ä¸€æ¬¡)

        answers.forEach(ans => {
            ans.rankedTags.forEach((tag, idx) => {
                let score = 4 - idx;
                
                // å€åˆ†éšªç¨®èˆ‡åå¥½
                if (tag.includes('åå¥½_') || tag.includes('ç†è³ _')) {
                    if (!prefStructure[tag]) prefStructure[tag] = 0;
                    prefStructure[tag] += score;
                } else {
                    if (!scores[tag]) scores[tag] = 0;
                    scores[tag] += score;
                }
            });
        });

        // 2. æ’åºåˆ†æ•¸
        let sortedScores = Object.entries(scores).sort((a, b) => b[1] - a[1]);
        let sortedPrefs = Object.entries(prefStructure).sort((a, b) => b[1] - a[1]);

        // 3. ç”Ÿæˆå ±å‘Š
        let report = `ã€ğŸ“Š å…¨æ–¹ä½ä¿éšªåˆ†æå ±å‘Šã€‘\n=========================\n`;
        report += `ğŸ§‘ å®¢æˆ¶ï¼š${name} (${sex})\n`;
        report += `ğŸ‚ ç”Ÿæ—¥ï¼š${dob}\n`;
        report += `ğŸ’¼ è·æ¥­ï¼š${job}\n`;
        report += `ğŸ“± è¯çµ¡ï¼š${contact}\n`;
        report += `ğŸ“‹ æ¨¡å¼ï¼š${currentMode}\n\n`;

        report += `ğŸ† ã€éšªç¨®é‡è¦–åº¦æ’åã€‘(å¾—åˆ†)\n`;
        sortedScores.forEach((item, index) => {
            report += `No.${index+1} ğŸ”´ ${item[0]} (${item[1]}åˆ†)\n`;
        });

        report += `\nğŸ§  ã€çµæ§‹èˆ‡è§€å¿µåå¥½ã€‘\n`;
        sortedPrefs.forEach((item) => {
            report += `ğŸ”¹ ${item[0].replace('åå¥½_','').replace('ç†è³ _','')} (${item[1]}åˆ†)\n`;
        });

        // ğŸŸ¢ 4. ä¿å–®å¥æª¢è¨»è¨˜
        report += `\n-------------------------\n`;
        if (isKnown) {
            report += `âœ… å®¢æˆ¶æ¸…æ¥šæ—¢æœ‰ä¿éšœ (å¯ç›´æ¥é‡å°ç¼ºå£è¦åŠƒ)\n`;
        } else {
            report += `âš ï¸ å®¢æˆ¶ä¸æ¸…æ¥šæ—¢æœ‰ä¿éšœ (å¼·çƒˆå»ºè­°ï¼šå…ˆåšä¿å–®å¥æª¢ï¼Œå†åšè¦åŠƒï¼)\n`;
        }

        report += `\nã€è©³ç´°æ’åºç´€éŒ„ã€‘\n`;
        answers.forEach((ans, idx) => {
            report += `${idx+1}. ${ans.q}\n   â”” ${ans.rankedTags.join(' > ')}\n`;
        });

        // 5. å‚³é€
        let formData = {
            name: name,
            mode: currentMode,
            analysis: report
        };

        fetch(scriptURL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(formData)
        })
        .then(() => {
            let resultHTML = `
                <div style="text-align:center;">
                    <h2 style="color: #27ae60;">âœ… åˆ†æå®Œæˆ</h2>
                    <p>æ„Ÿè¬æ‚¨çš„å¡«å¯«ï¼</p>
                    <p>æ ¹æ“šæ’åºçµæœï¼Œæˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„éœ€æ±‚æ¬Šé‡ã€‚</p>
            `;
            
            // å¦‚æœéœ€è¦å¥æª¢ï¼Œç‰¹åˆ¥é¡¯ç¤ºæé†’
            if (!isKnown) {
                resultHTML += `
                    <div style="background:#fff3cd; color:#856404; padding:15px; border-radius:8px; margin:15px 0;">
                        <strong>ğŸ’¡ è²¼å¿ƒæé†’</strong><br>
                        ç”±æ–¼æ‚¨ä¸å¤ªç¢ºå®šç›®å‰çš„ä¿éšœå…§å®¹ï¼Œ<br>
                        å»ºè­°è«®è©¢æ™‚ï¼Œè«‹é¡§å•å”åŠ©æ‚¨é€²è¡Œ<b>ã€Œä¿å–®å¥æª¢ã€</b>ï¼Œ<br>
                        ä»¥å…é‡è¤‡æŠ•ä¿å¤šèŠ±éŒ¢å–”ï¼
                    </div>
                `;
            }

            resultHTML += `<button class="nav-btn ready" onclick="location.reload()">é—œé–‰</button></div>`;
            document.getElementById('final-message').innerHTML = resultHTML;
        })
        .catch(() => alert("å‚³é€å¤±æ•—"));
    }
</script>

</body>
</html>
