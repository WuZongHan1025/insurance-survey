<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¨æ–¹ä½ä¿éšªéœ€æ±‚æ¬Šé‡åˆ†æ</title>

<style>
:root {
  --primary:#2c3e50;
  --accent:#e74c3c;
  --selected:#27ae60;
  --bg:#f8f9fa;
  --card:#ffffff;
  --text:#333;
}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);margin:0;padding:20px;
  display:flex;justify-content:center;align-items:center;min-height:100vh;
}
.container{
  background:var(--card);max-width:620px;width:100%;
  padding:30px;border-radius:12px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}
h2,h3,h4{text-align:center;color:var(--primary);}
p{text-align:center;color:#666;line-height:1.6}
.progress-bar{height:6px;background:#eee;border-radius:3px;margin-bottom:20px;overflow:hidden}
.progress-fill{height:100%;background:var(--accent);width:0%;transition:.3s}

input[type=text],input[type=tel]{
  width:100%;padding:12px;margin-bottom:15px;
  border:1px solid #ddd;border-radius:6px;font-size:16px;
  box-sizing: border-box;
}
.radio-group{display:flex;gap:10px;margin-bottom:15px}
.radio-label{
  flex:1;border:1px solid #ddd;border-radius:6px;
  padding:10px;display:flex;align-items:center;gap:6px;cursor:pointer;
}

.option-pool{display:flex;flex-direction:column;gap:12px}
.option-card{
  border:2px solid #e0e0e0;border-radius:10px;
  padding:15px;cursor:pointer;
  display:flex;align-items:center;transition:.2s
}
.option-card:hover{background:#f9f9f9}
.option-card.selected{border-color:var(--selected);background:#f0fff4}
.rank-box{
  width:32px;height:32px;border-radius:6px;
  border:2px solid #ccc;margin-right:12px;
  display:flex;align-items:center;justify-content:center;
  font-weight:bold;flex-shrink:0;background:#fff;
}
.option-card.selected .rank-box{
  background:var(--selected);color:#fff;border-color:var(--selected)
}

.nav-btn{
  width:100%;padding:14px;border:none;border-radius:6px;
  font-size:16px;margin-top:20px;
  background:#aaa;color:#fff;opacity:.5;pointer-events:none;transition:.3s;
}
.nav-btn.ready{background:var(--accent);opacity:1;pointer-events:auto}

.step{display:none; animation: fadeIn 0.4s;}
.step.active{display:block}

@keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

.check-btn-group{display:flex;gap:15px;margin-top:20px}
.check-btn{
  flex:1;padding:15px;border-radius:8px;
  border:2px solid #ddd;background:#fff;font-weight:bold;cursor:pointer
}
.check-btn.yes{border-color:var(--selected);color:var(--selected)}
.check-btn.no{border-color:var(--accent);color:var(--accent)}
</style>
</head>

<body>
<div class="container">
<div class="progress-bar"><div class="progress-fill" id="progress"></div></div>

<div id="step-intro" class="step active">
<h2>ğŸ“Š ä¿éšªéœ€æ±‚æ¬Šé‡åˆ†æ</h2>
<p>è«‹å”åŠ©å¡«å¯«åŸºæœ¬è³‡æ–™ï¼Œ<br>è®“æˆ‘å€‘èƒ½æä¾›ç²¾æº–çš„ä¿éšœå»ºè­°ã€‚</p>

<label>å§“å</label><input id="clientName" type="text" placeholder="è«‹è¼¸å…¥å§“å">
<label>æ€§åˆ¥</label>
<div class="radio-group">
<label class="radio-label"><input type="radio" name="clientSex" value="ç”·">ç”·</label>
<label class="radio-label"><input type="radio" name="clientSex" value="å¥³">å¥³</label>
</div>
<label>ç”Ÿæ—¥ (å¦‚: 19850101)</label><input id="clientDob" type="tel" placeholder="YYYYMMDD" maxlength="8">
<label>è·æ¥­</label><input id="clientJob" type="text" placeholder="ä¾‹å¦‚: å·¥ç¨‹å¸«">
<label>è¯çµ¡æ–¹å¼ (æ‰‹æ©Ÿ/Line)</label><input id="clientContact" type="text" placeholder="09xxxxxxxx">

<hr style="border:0; border-top:1px dashed #ccc; margin:20px 0;">
<h3 style="color:var(--accent)">æœ¬æ¬¡è¦åŠƒå°è±¡</h3>
<div class="option-pool">
<button class="option-card" style="justify-content:center;font-weight:bold" onclick="selectTarget('self')">A. åªæœ‰æˆ‘è‡ªå·±</button>
<button class="option-card" style="justify-content:center;font-weight:bold" onclick="selectTarget('family')">B. åªæœ‰å®¶äºº</button>
<button class="option-card" style="justify-content:center;font-weight:bold" onclick="selectTarget('both')">C. è‡ªå·±ï¼‹å®¶äºº</button>
</div>
</div>

<div id="step-question" class="step">
<h4 id="q-category" style="color:#999;margin:0"></h4>
<h3 id="q-text" style="margin-top:5px"></h3>
<p style="color:var(--accent);font-size:0.9em">è«‹ä¾ç…§é‡è¦–ç¨‹åº¦é»é¸ 1ï½4 å</p>
<div class="option-pool" id="q-options"></div>
<button id="next-btn" class="nav-btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â”</button>
<p style="text-align:center;cursor:pointer;font-size:0.8em;color:#999;margin-top:10px" onclick="resetCurrentRank()">â†» é‡æ–°æ’åºæœ¬é¡Œ</p>
</div>

<div id="step-check" class="step">
<h2>ğŸ›¡ï¸ æœ€å¾Œç¢ºèª</h2>
<p style="font-weight:bold;font-size:1.1em">è«‹å•æ‚¨æ¸…æ¥šè‡ªå·±ç›®å‰èº«ä¸Šæ—¢æœ‰çš„<br>ã€Œæ‰€æœ‰ä¿éšœå…§å®¹ã€å—ï¼Ÿ</p>
<p style="font-size:0.9em">(åŒ…å«å…¬å¸åœ˜ä¿ã€çˆ¶æ¯è²·çš„ä¿å–®...ç­‰)</p>
<div class="check-btn-group">
<button class="check-btn yes" onclick="finishCheck(true)">âœ… æ˜¯ï¼Œæˆ‘å¾ˆæ¸…æ¥š</button>
<button class="check-btn no" onclick="finishCheck(false)">âŒ å¦ï¼Œä¸å¤ªç¢ºå®š</button>
</div>
</div>

<div id="step-result" class="step">
<div id="final-message">
<h2>ğŸ”„ åˆ†æä¸­...</h2>
<p>æ­£åœ¨ç”Ÿæˆæ‚¨çš„å°ˆå±¬å ±å‘Š</p>
</div>
</div>

</div>

<script>
/* ===== 1. è¨­å®šèˆ‡é¡Œåº« ===== */
// ğŸ”´ è«‹å‹™å¿…ç¢ºèªé€™è£¡æ›æˆä½ çš„ Google Script ç¶²å€
const scriptURL = "https://script.google.com/macros/s/AKfycbwNNc9BZ0AJzTGGYK4cnqAsuA78FtWMuuVoJMmn4hZpOSWuVCy0N6eLyPk-h414ZkJD/exec";

const RANK_WEIGHTS = [4,3,2,1];
const TAG_MAP = {
  care:"é•·ç…§/å¤±èƒ½", medical:"é†«ç™‚/å¯¦æ”¯",
  critical:"é‡å¤§/ç™Œç—‡", accident:"æ„å¤–/å‚·å®³", life:"å£½éšª/è²¬ä»»",
  "åå¥½_è³‡ç”¢":"çµæ§‹_è³‡ç”¢ç´¯ç©", "åå¥½_é‚„æœ¬":"çµæ§‹_çµ‚èº«é‚„æœ¬",
  "åå¥½_æ¶ˆè²»":"çµæ§‹_å®šæœŸæ¶ˆè²»", "åå¥½_æ§“æ¡¿":"çµæ§‹_å®šæœŸé«˜æ§“æ¡¿",
  "ç†è³ _åˆ†æœŸ":"æœˆçµ¦ä»˜å‹", "ç†è³ _å¯¦æ”¯":"å¯¦æ”¯å¯¦ä»˜", 
  "ç†è³ _ä¸€æ¬¡é‡‘":"ä¸€æ¬¡é‡‘å‹", "ç†è³ _å®šé¡":"å®šé¡çµ¦ä»˜"
};

// ã€è‡ªæˆ‘è¦åŠƒã€‘ç²¾ç°¡ 5 é¡Œ
const questionsSelf = [
    { 
        id: "A1", cat: "ã€è‡ªæˆ‘ã€‘æ ¸å¿ƒç—›é»", 
        title: "å¦‚æœçœŸçš„é‡åˆ°ç‹€æ³ï¼Œä½ æœ€ä¸å¸Œæœ›ç™¼ç”Ÿçš„æ˜¯å“ªä¸€ç¨®ï¼Ÿ", 
        options: [
            { text: "éœ€è¦é•·æ™‚é–“è¢«ç…§é¡§ï¼Œç”Ÿæ´»å“è³ªå¤§å¹…ä¸‹é™", tag: "care" },
            { text: "ç”Ÿä¸€å ´å¾ˆé‡çš„ç—…ï¼Œçªç„¶è¦æ‹¿å‡ºä¸€å¤§ç­†éŒ¢", tag: "critical" },
            { text: "å¸¸å¸¸é€²å‡ºé†«é™¢ï¼Œå°éŒ¢ç´¯ç©æˆå¤§è² æ“”", tag: "medical" },
            { text: "å¤ªçªç„¶é›¢é–‹ï¼Œå¾ˆå¤šäº‹æƒ…ä¾†ä¸åŠäº¤ä»£", tag: "life" }
        ]
    },
    { 
        id: "A2", cat: "ã€è‡ªæˆ‘ã€‘é¢¨éšªèªçŸ¥", 
        title: "ä»¥å¹´ç´€ã€ç”Ÿæ´»å‹æ…‹ä¾†çœ‹ï¼Œä½ è¦ºå¾—å“ªç¨®ç‹€æ³æ¯”è¼ƒå¯èƒ½ç™¼ç”Ÿï¼Ÿ", 
        options: [
            { text: "èº«é«”æ…¢æ…¢è®Šå·®ï¼Œéœ€è¦äººå¹«å¿™", tag: "care" },
            { text: "çªç„¶è¢«è¨ºæ–·å‡ºé‡å¤§çš„ç—…", tag: "critical" },
            { text: "å› ç‚ºæ‰‹è¡“æˆ–ä½é™¢ï¼ŒèŠ±è²»è®Šå¤š", tag: "medical" },
            { text: "ä¸å°å¿ƒè·Œå€’ã€è»Šç¦æˆ–æ„å¤–å—å‚·", tag: "accident" }
        ]
    },
    { 
        id: "A3", cat: "ã€è‡ªæˆ‘ã€‘ç†è³ åå¥½", 
        title: "å¦‚æœçœŸçš„æ´¾ä¸Šç”¨å ´ï¼Œä½ å¸Œæœ›é€™ç­†éŒ¢æ˜¯æ€éº¼å¹«ä¸Šå¿™ï¼Ÿ", 
        options: [
            { text: "æ¯å€‹æœˆéƒ½æœ‰ä¸€ç­†éŒ¢ï¼Œå¯ä»¥å®‰å¿ƒç”Ÿæ´»", tag: "care" },
            { text: "èŠ±å¤šå°‘è£œå¤šå°‘ï¼Œä¸ç”¨è‡ªå·±æ‰›", tag: "medical" },
            { text: "ä¸€æ¬¡æ‹¿åˆ°ä¸€ç­†éŒ¢ï¼Œè‡ªç”±å®‰æ’", tag: "critical" },
            { text: "ç™¼ç”Ÿå°±çµ¦å›ºå®šé‡‘é¡ï¼Œç°¡å–®æ˜ç¢º", tag: "accident" }
        ]
    },
    { 
        id: "A4", cat: "ã€è‡ªæˆ‘ã€‘è³‡é‡‘è§€å¿µ", 
        title: "å¦‚æœé€™ç­†éŒ¢æœ€å¾Œæ²’æœ‰çœŸçš„ç”¨åˆ°ï¼Œä½ å¸Œæœ›å®ƒï¼Ÿ", 
        options: [
            { text: "è®Šæˆä¹‹å¾Œèƒ½ç”¨çš„ä¸€ç­†è³‡ç”¢", tag: "åå¥½_è³‡ç”¢" },
            { text: "è‡³å°‘èƒ½ç•™çµ¦å®¶äººï¼Œä¸æœƒç™½ç¹³", tag: "åå¥½_é‚„æœ¬" },
            { text: "æœ‰ç”¨åˆ°æœ€å¥½ï¼Œæ²’ç”¨åˆ°ä¹Ÿèƒ½æ¥å—", tag: "åå¥½_æ¶ˆè²»" },
            { text: "åªè¦ç¾åœ¨å®‰å¿ƒå°±å¥½ï¼Œä»¥å¾Œä¸é‡è¦", tag: "åå¥½_æ§“æ¡¿" }
        ]
    },
    { 
        id: "A5", cat: "ã€è‡ªæˆ‘ã€‘æ ¸å¿ƒåƒ¹å€¼", 
        title: "å¦‚æœç¾åœ¨åªèƒ½å…ˆé¡§ä¸€ä»¶äº‹ï¼Œä½ æœƒå„ªå…ˆé¡§ï¼Ÿ", 
        options: [
            { text: "ä»¥å¾Œçš„ç”Ÿæ´»å“è³ªï¼Œä¸æƒ³æ‹–ç´¯å®¶äºº", tag: "care" },
            { text: "ç”Ÿç—…æ™‚æœ‰è¶³å¤ é¸æ“‡ï¼Œä¸è¢«éŒ¢é™åˆ¶", tag: "medical" },
            { text: "çªç™¼ç‹€æ³ä¾†æ™‚ï¼Œæ‰‹é ­æœ‰éŒ¢ä¸æ…Œäº‚", tag: "critical" },
            { text: "å®¶äººçš„ç¶“æ¿Ÿèˆ‡è²¬ä»»èƒ½è¢«äº¤ä»£å¥½", tag: "life" }
        ]
    }
];

// ã€å®¶äººè¦åŠƒã€‘ç²¾ç°¡ 5 é¡Œ
const questionsFamily = [
    { 
        id: "B1", cat: "ã€å®¶äººã€‘ç”Ÿæ´»è¡æ“Š", 
        title: "å¦‚æœå®¶äººç”Ÿç—…ï¼Œå“ªä¸€ç¨®ç‹€æ³æœ€å¯èƒ½è®“ä½ çš„ç”Ÿæ´»æ•´å€‹è¢«æ”¹è®Šï¼Ÿ", 
        options: [
            { text: "é•·æ™‚é–“ç…§é¡§ï¼Œç”Ÿæ´»è¢«ç¶ä½", tag: "care" },
            { text: "ä¸€æ¬¡è¦æ‹¿å‡ºä¸€å¤§ç­†ç¾é‡‘", tag: "critical" },
            { text: "å¸¸å¸¸è·‘é†«é™¢ï¼ŒéŒ¢æ…¢æ…¢è¢«åƒæ‰", tag: "medical" },
            { text: "çªç™¼äº‹æ•…ï¼Œäº‹æƒ…ä¾†å¾—åˆæ€¥åˆäº‚", tag: "accident" }
        ]
    },
    { 
        id: "B2", cat: "ã€å®¶äººã€‘ç¶“æ¿Ÿå£“åŠ›", 
        title: "å¦‚æœçœŸçš„éœ€è¦ç”¨éŒ¢ï¼Œä½ æœ€æ“”å¿ƒçš„æ˜¯ï¼Ÿ", 
        options: [
            { text: "æ¯å€‹æœˆéƒ½è¦å›ºå®šæ”¯å‡ºï¼Œæ’å¾ˆä¹…", tag: "care" },
            { text: "ç•¶ä¸‹æ‹¿ä¸å‡ºä¾†ï¼Œå¿…é ˆåˆ°è™•å€Ÿ", tag: "critical" },
            { text: "ä¸çŸ¥é“å“ªäº›è©²èŠ±ã€å“ªäº›ä¸è©²èŠ±", tag: "medical" },
            { text: "å°æ„å¤–ä¸€ç›´ä¾†ï¼Œç´¯ç©æˆè² æ“”", tag: "accident" }
        ]
    },
    { 
        id: "B3", cat: "ã€å®¶äººã€‘å®¶åº­å’Œè«§", 
        title: "å“ªä¸€ç¨®è³ å„Ÿæ–¹å¼ï¼Œæœ€ä¸å®¹æ˜“é€ æˆå®¶åº­å£“åŠ›æˆ–çˆ­åŸ·ï¼Ÿ", 
        options: [
            { text: "æ¯å€‹æœˆå›ºå®šæœ‰éŒ¢ï¼Œä¸ç”¨è¨è«–", tag: "care" },
            { text: "ä¸€æ¬¡çµ¦ä¸€ç­†ï¼Œå¤§å®¶åä¸‹ä¾†æ±ºå®š", tag: "critical" },
            { text: "èŠ±å¤šå°‘è£œå¤šå°‘ï¼Œä¸ç”¨ç®—èª°å‡º", tag: "medical" },
            { text: "ç™¼ç”Ÿå°±çµ¦å®šé¡ï¼Œç°¡å–®è™•ç†", tag: "accident" }
        ]
    },
    { 
        id: "B4", cat: "ã€å®¶äººã€‘ç…§é¡§æ›¿ä»£", 
        title: "å‡è¨­ä½ ç„¡æ³•éš¨æ™‚åœ¨æ—é‚Šï¼Œä½ æœ€å¸Œæœ›å“ªä»¶äº‹æœ‰äººå¹«ä½ æ‰›ï¼Ÿ", 
        options: [
            { text: "æœ‰äººèƒ½ç›´æ¥è™•ç†ã€Œç…§é¡§å•é¡Œã€", tag: "care" },
            { text: "æœ‰éŒ¢èƒ½è«‹äººã€Œåˆ†æ“”ä½ çš„è§’è‰²ã€", tag: "critical" },
            { text: "æœ‰è³‡æºè®“ã€Œæ²»ç™‚é¸æ“‡ã€æ›´å¤š", tag: "medical" },
            { text: "è‡³å°‘ã€Œçªç™¼ç‹€æ³ã€æœ‰äººèƒ½æ‡‰ä»˜", tag: "accident" }
        ]
    },
    { 
        id: "B5", cat: "ã€å®¶äººã€‘æœ€å¾Œåº•ç·š", 
        title: "å¹«å®¶äººè¦åŠƒæ™‚ï¼Œå“ªä¸€ä»¶äº‹ä½ æœ€ä¸èƒ½æ‰¿å—ï¼Ÿ", 
        options: [
            { text: "å®¶äººéœ€è¦ç…§é¡§ï¼Œä½†æˆ‘æ’ä¸ä¸‹å»", tag: "care" },
            { text: "å•é¡Œæ‹–å¾ˆä¹…ï¼Œå½±éŸ¿æ•´å€‹å®¶åº­", tag: "critical" },
            { text: "é†«ç”Ÿèªªå¯ä»¥æ•‘ï¼Œä½†æˆ‘æ‹¿ä¸å‡ºéŒ¢", tag: "medical" },
            { text: "ä¸€å€‹æ„å¤–ï¼Œè®“äº‹æƒ…ç¬é–“å¤±æ§", tag: "accident" }
        ]
    }
];

/* ===== 2. æ ¸å¿ƒé‚è¼¯ ===== */
let currentMode="", currentQueue=[], answers=[], currentIndex=0, currentRank=[];
let totalQuestions=0, finishedQuestions=0;

function selectTarget(mode){
  const name=document.getElementById("clientName").value.trim();
  const dob=document.getElementById("clientDob").value.trim();
  const job=document.getElementById("clientJob").value.trim();
  const contact=document.getElementById("clientContact").value.trim();
  const sex=[...document.getElementsByName("clientSex")].find(x=>x.checked)?.value;
  
  if(!name||!dob||!job||!contact||!sex){alert("è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼Œä»¥ä¾¿æˆ‘å€‘æä¾›ç²¾æº–åˆ†æï¼");return;}
  
  currentMode=mode;
  currentQueue=(mode==="family")?questionsFamily:questionsSelf;
  totalQuestions=(mode==="both")?(questionsSelf.length+questionsFamily.length):currentQueue.length;
  
  document.getElementById("step-intro").classList.remove("active");
  document.getElementById("step-question").classList.add("active");
  loadQuestion();
}

function loadQuestion(){
  if(currentIndex>=currentQueue.length){handleQueueFinish();return;}
  currentRank=[];
  const q=currentQueue[currentIndex];
  document.getElementById("q-category").innerText=q.cat;
  document.getElementById("q-text").innerText=q.title;
  document.getElementById("progress").style.width=(finishedQuestions/totalQuestions*100)+"%";
  renderOptions();
}

function renderOptions(){
  const q=currentQueue[currentIndex];
  const pool=document.getElementById("q-options");pool.innerHTML="";
  q.options.forEach((o,i)=>{
    const idx=currentRank.indexOf(i);
    const div=document.createElement("div");
    div.className="option-card"+(idx>-1?" selected":"");
    div.onclick=()=>toggleOption(i);
    div.innerHTML=`<div class="rank-box">${idx>-1?idx+1:""}</div><div class="option-text">${o.text}</div>`;
    pool.appendChild(div);
  });
  const btn=document.getElementById("next-btn");
  btn.classList.toggle("ready",currentRank.length===4);
}

function toggleOption(i){
  const idx=currentRank.indexOf(i);
  if(idx>-1)currentRank.splice(idx,1);
  else if(currentRank.length<4)currentRank.push(i);
  renderOptions();
}
function resetCurrentRank(){currentRank=[];renderOptions();}

function nextQuestion(){
  if(currentRank.length<4)return;
  const q=currentQueue[currentIndex];
  answers.push({
    mode:currentQueue===questionsSelf?"self":"family",
    title:q.title,
    rankedTags:currentRank.map(i=>q.options[i].tag)
  });
  currentIndex++;finishedQuestions++;loadQuestion();
}

function handleQueueFinish(){
  if(currentMode==="both" && currentQueue===questionsSelf){
    alert("ç¬¬ä¸€éšæ®µå®Œæˆï¼æ¥ä¸‹ä¾†é€²å…¥å®¶äººè¦åŠƒéƒ¨åˆ†ã€‚");
    currentQueue=questionsFamily;currentIndex=0;loadQuestion();
  }else{
    document.getElementById("step-question").classList.remove("active");
    document.getElementById("step-check").classList.add("active");
  }
}

function finishCheck(isKnown){
  document.getElementById("step-check").classList.remove("active");
  document.getElementById("step-result").classList.add("active");

  // 1. æŠ“å–å®¢æˆ¶è³‡æ–™
  const name = document.getElementById("clientName").value;
  const dob = document.getElementById("clientDob").value;
  const job = document.getElementById("clientJob").value;
  const contact = document.getElementById("clientContact").value;
  const sex = [...document.getElementsByName("clientSex")].find(x=>x.checked)?.value;

  // 2. è¨ˆç®—åˆ†æ•¸
  let scores={self:{care:0,medical:0,critical:0,accident:0,life:0},
              family:{care:0,medical:0,critical:0,accident:0,life:0}};
  
  answers.forEach(a=>a.rankedTags.forEach((t,i)=>{
      // æ’é™¤åå¥½é¡æ¨™ç±¤ï¼Œåªè¨ˆç®—éšªç¨®åˆ†æ•¸
      if(scores[a.mode][t] !== undefined) {
          scores[a.mode][t] += RANK_WEIGHTS[i];
      }
  }));
  
  function sort(o){return Object.entries(o).sort((a,b)=>b[1]-a[1]);}
  const sortedSelf=sort(scores.self);
  const sortedFamily=sort(scores.family);

  // 3. ç”Ÿæˆå ±å‘Š (åŒ…å«å€‹è³‡)
  let report = `ã€ğŸ§‘ å®¢æˆ¶æª”æ¡ˆã€‘\n`;
  report += `å§“åï¼š${name} (${sex})\n`;
  report += `ç”Ÿæ—¥ï¼š${dob}\n`;
  report += `è·æ¥­ï¼š${job}\n`;
  report += `è¯çµ¡ï¼š${contact}\n`;
  report += `ä¿å–®å¥æª¢æ„é¡˜ï¼š${isKnown ? "æ¸…æ¥šæ—¢æœ‰ä¿éšœ" : "âš ï¸ ä¸æ¸…æ¥š (å»ºè­°å¥æª¢)"}\n`;
  report += `------------------------\n`;
  
  report += `ã€ğŸ“Š æ¬Šé‡åˆ†æçµæœã€‘\n`;
  
  if(currentMode === "self" || currentMode === "both"){
      report += `[è‡ªæˆ‘è¦åŠƒ - é‡è¦–é †åº]\n` + sortedSelf.map(s=>`ğŸ”¹${TAG_MAP[s[0]] || s[0]}: ${s[1]}åˆ†`).join("\n");
      // æ‰¾å‡ºè‡ªæˆ‘çµæ§‹åå¥½
      let selfPrefs = answers.filter(a=>a.mode==="self").flatMap(a=>a.rankedTags).filter(t=>t.includes("åå¥½_"));
      if(selfPrefs.length > 0) report += `\n(è³‡é‡‘åå¥½å‰3: ${TAG_MAP[selfPrefs[0]]}, ${TAG_MAP[selfPrefs[1]]})`;
      report += `\n\n`;
  }
  
  if(currentMode === "family" || currentMode === "both"){
      report += `[å®¶äººè¦åŠƒ - é‡è¦–é †åº]\n` + sortedFamily.map(s=>`ğŸ”¸${TAG_MAP[s[0]] || s[0]}: ${s[1]}åˆ†`).join("\n");
  }

  // 4. å‚³é€
  fetch(scriptURL, {
    method: "POST",
    mode: "no-cors", 
    headers: {"Content-Type": "text/plain"},
    body: JSON.stringify({
        name: name,
        mode: currentMode,
        analysis: report
    })
  })
  .then(() => {
      let msg = `<h2 style='color:#27ae60'>âœ… æäº¤æˆåŠŸ</h2><p>é¡§å•å°‡ç›¡å¿«èˆ‡æ‚¨è¯ç¹«</p>`;
      if(!isKnown) msg += `<div style='background:#fff3cd;color:#856404;padding:10px;border-radius:6px;margin-top:10px'>ğŸ’¡ è²¼å¿ƒæé†’ï¼šå»ºè­°é ç´„ä¿å–®å¥æª¢ï¼Œé¿å…é‡è¤‡æŠ•ä¿ï¼</div>`;
      document.getElementById("final-message").innerHTML = msg;
  })
  .catch(() => alert("å‚³é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯"));
}
</script>
</body>
</html>
