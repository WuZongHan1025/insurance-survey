<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¨æ–¹ä½ä¿éšªéœ€æ±‚æ¬Šé‡åˆ†æ (æ­£å¼ç‰ˆ)</title>

<style>
/* =========================================
   ğŸ¨ è¦–è¦ºè¨­è¨ˆç³»çµ± (Professional UI/UX)
   ========================================= */
:root { 
    --primary: #2c3e50; 
    --accent: #c0392b; 
    --selected: #27ae60; 
    --bg: #f8f9fa; 
    --card: #ffffff; 
    --text: #333; 
}
body { 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
    background: var(--bg); margin: 0; padding: 20px; 
    display: flex; justify-content: center; align-items: center; min-height: 100vh; flex-direction: column;
}
.container { 
    background: var(--card); max-width: 620px; width: 100%; 
    padding: 30px; border-radius: 12px; 
    box-shadow: 0 10px 25px rgba(0,0,0,0.08); position: relative; 
}
h2, h3, h4 { text-align: center; color: var(--primary); }
p { text-align: center; color: #666; line-height: 1.6; }

/* é€²åº¦æ¢ */
.progress-bar { height: 6px; background: #eee; border-radius: 3px; margin-bottom: 20px; overflow: hidden; }
.progress-fill { height: 100%; background: var(--accent); width: 0%; transition: .3s; }

/* è¼¸å…¥æ¡†å„ªåŒ– */
input[type=text], input[type=tel] { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; transition: 0.3s; }
input:focus { border-color: var(--primary); outline: none; }

.radio-group { display: flex; gap: 10px; margin-bottom: 15px; }
.radio-label { flex: 1; border: 1px solid #ddd; border-radius: 6px; padding: 10px; display: flex; align-items: center; gap: 6px; cursor: pointer; transition: 0.2s; }
.radio-label:hover { background: #f1f1f1; }

/* é¸é …å¡ç‰‡ (äº’å‹•æ ¸å¿ƒ) */
.option-pool { display: flex; flex-direction: column; gap: 12px; }
.option-card { border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; cursor: pointer; display: flex; align-items: center; transition: .2s; background: #fff; position: relative; }
.option-card:active { transform: scale(0.98); }
.option-card.selected { border-color: var(--selected); background: #f0fff4; }
.rank-box { width: 32px; height: 32px; border-radius: 6px; border: 2px solid #ccc; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; background: #fff; transition: .2s; }
.option-card.selected .rank-box { background: var(--selected); color: #fff; border-color: var(--selected); }

/* æŒ‰éˆ•ç³»çµ± */
.nav-btn { width: 100%; padding: 14px; border: none; border-radius: 6px; font-size: 16px; margin-top: 20px; background: #aaa; color: #fff; opacity: .5; pointer-events: none; transition: .3s; cursor: not-allowed; }
.nav-btn.ready { background: var(--accent); opacity: 1; pointer-events: auto; cursor: pointer; box-shadow: 0 4px 10px rgba(192, 57, 43, 0.3); }

/* å‹•ç•«èˆ‡æ­¥é©Ÿ */
.step { display: none; animation: fadeIn 0.4s; }
.step.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* ç¢ºèªæŒ‰éˆ• */
.check-btn-group { display: flex; gap: 15px; margin-top: 20px; }
.check-btn { flex: 1; padding: 15px; border-radius: 8px; border: 2px solid #ddd; background: #fff; font-weight: bold; cursor: pointer; }
.check-btn.yes { border-color: var(--selected); color: var(--selected); }
.check-btn.no { border-color: var(--accent); color: var(--accent); }

/* çµæœé  (å‰å°æ¨¡ç³ŠåŒ–è¨­è¨ˆ) */
.result-card { border-radius: 10px; padding: 25px; margin-top: 20px; text-align: left; color: #333; border-left: 6px solid #ccc; background: #f9f9f9; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
.result-type-1 { border-left-color: #3498db; background: #eaf6ff; } /* è— */
.result-type-2 { border-left-color: #95a5a6; background: #f4f6f7; } /* ç° */
.result-type-3 { border-left-color: #f1c40f; background: #fffbe6; } /* é»ƒ */
.result-type-4 { border-left-color: #8e44ad; background: #f3e5f5; } /* ç´« */

.result-title { font-size: 1.5em; font-weight: bold; margin-bottom: 12px; display: block; }
.result-desc { font-size: 1em; line-height: 1.6; color: #444; }
.tag-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; margin-right: 5px; margin-bottom: 5px; color: white; }
.bg-blue { background: #3498db; }
.bg-green { background: #27ae60; }
.bg-purple { background: #8e44ad; }
.bg-orange { background: #f39c12; }

.strategy-box { border-top: 1px dashed #ccc; margin-top: 20px; padding-top: 15px; font-size: 0.95em; color: #555; background: rgba(255,255,255,0.5); padding: 15px; border-radius: 8px; }
.disclaimer { font-size: 0.8em; color: #999; margin-top: 30px; border-top: 1px solid #eee; padding-top: 10px; text-align: center; line-height: 1.4; }

/* äº’å‹•æ»‘æ¡¿ */
.slider-container { margin: 20px 0; padding: 20px; background: #fff8e1; border-radius: 12px; border: 2px dashed #f39c12; display: none; text-align: center; }
.slider-label { display: flex; justify-content: space-between; font-size: 0.85em; color: #666; margin-bottom: 15px; font-weight: bold; }
input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; }
input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: var(--accent); cursor: pointer; margin-top: -10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #ddd; border-radius: 3px; }
</style>
</head>

<body>
<div class="container">
<div class="progress-bar"><div class="progress-fill" id="progress"></div></div>

<div id="step-intro" class="step active">
    <h2>ğŸ“Š å…¨æ–¹ä½ä¿éšªéœ€æ±‚æ¬Šé‡åˆ†æ</h2>
    <p>é€éæƒ…å¢ƒæ¨¡æ“¬ï¼Œé‡æ¸…æ‚¨çš„ä¿éšœå„ªå…ˆç´šã€‚<br><span style="color:#e74c3c;font-size:0.8em;">*ç‚ºç¢ºä¿è²»ç‡è¨ˆç®—æº–ç¢ºï¼Œè«‹å¡«å¯«çœŸå¯¦è³‡æ–™</span></p>

    <label>çœŸå¯¦å§“å</label><input id="clientName" type="text" placeholder="è«‹è¼¸å…¥ä¸­æ–‡æˆ–è‹±æ–‡å§“å">
    
    <label>ç”Ÿç†æ€§åˆ¥ (å½±éŸ¿è²»ç‡è¨ˆç®—)</label>
    <div class="radio-group">
        <label class="radio-label"><input type="radio" name="clientSex" value="ç”·">ç”·</label>
        <label class="radio-label"><input type="radio" name="clientSex" value="å¥³">å¥³</label>
    </div>
    
    <label>å‡ºç”Ÿå¹´ (å¦‚: 75å¹´æ¬¡ æˆ– 1986)</label><input id="clientDob" type="text" placeholder="è«‹è¼¸å…¥å¹´ä»½å³å¯">
    <label>è·æ¥­ (å¦‚: è‡ªç”±æ¥­/å·¥ç¨‹å¸«)</label><input id="clientJob" type="text" placeholder="è·æ¥­é¡åˆ¥ (ä½œç‚ºé¢¨éšªè©•ä¼°åƒè€ƒ)">
    <label>è¯çµ¡æ–¹å¼ (æ‰‹æ©Ÿ / Line ID)</label><input id="clientContact" type="text" placeholder="æ–¹ä¾¿é¡§å•æä¾›å ±å‘Šçš„æ–¹å¼">

    <hr style="border:0; border-top:1px dashed #ccc; margin:20px 0;">
    <h3 style="color:var(--accent)">æœ¬æ¬¡è¦åŠƒå°è±¡</h3>
    <div class="option-pool">
        <button class="option-card" style="justify-content:center;font-weight:bold" onclick="selectTarget('self')">A. åªæœ‰æˆ‘è‡ªå·±</button>
        <button class="option-card" style="justify-content:center;font-weight:bold" onclick="selectTarget('family')">B. åªæœ‰å®¶äºº (çˆ¶æ¯/é…å¶/å°å­©)</button>
        <button class="option-card" id="btn-both" style="justify-content:center;font-weight:bold" onclick="showSlider()">C. è‡ªå·±ï¼‹å®¶äºº (é›™è»Œåˆ†æ)</button>
    </div>

    <div id="weight-slider-box" class="slider-container">
        <p style="margin:0 0 10px 0; font-weight:bold; color:#d35400;">âš–ï¸ åå¥½æ¨¡æ“¬ï¼šèª¿æ•´æ‚¨å¿ƒä¸­çš„æ¯”é‡</p>
        <div class="slider-label">
            <span>â¬…ï¸ é‡è¦–è‡ªå·± (90%)</span>
            <span style="color:var(--primary)">å„åŠ</span>
            <span>é‡è¦–å®¶äºº (90%) â¡ï¸</span>
        </div>
        <input type="range" id="weightSlider" min="10" max="90" value="50" step="10">
        <button id="slider-confirm-btn" class="nav-btn ready" onclick="selectTarget('both')" style="margin-top:15px;">ç¢ºèªä¸¦é–‹å§‹ â”</button>
    </div>
</div>

<div id="step-question" class="step">
    <h4 id="q-category" style="color:#999;margin:0"></h4>
    <h3 id="q-text" style="margin-top:5px"></h3>
    <p style="color:var(--accent);font-size:0.95em;background:#fff3cd;padding:8px;border-radius:5px;display:inline-block;">è«‹å¾ 5 å€‹é¸é …ä¸­ï¼Œé¸å‡ºæ‚¨æœ€åœ¨æ„çš„ <b>å‰ 3 å</b></p>
    <div class="option-pool" id="q-options" style="margin-top:15px"></div>
    <button id="next-btn" class="nav-btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â”</button>
    <p style="text-align:center;cursor:pointer;font-size:0.8em;color:#999;margin-top:10px" onclick="resetCurrentRank()">â†» é‡æ–°æ’åºæœ¬é¡Œ</p>
</div>

<div id="step-check" class="step">
    <h2>ğŸ›¡ï¸ æœ€å¾Œç¢ºèª</h2>
    <p style="font-weight:bold;font-size:1.1em">è«‹å•æ‚¨æ¸…æ¥šè‡ªå·±ç›®å‰èº«ä¸Šæ—¢æœ‰çš„<br>ã€Œæ‰€æœ‰ä¿éšœå…§å®¹ã€å—ï¼Ÿ</p>
    <p style="font-size:0.9em; color:#666">(è‹¥ä¸æ¸…æ¥šé¸ã€Œå¦ã€ï¼Œé¡§å•å°‡æœƒå”åŠ©æ‚¨é€²è¡Œä¿å–®å¥æª¢ï¼Œé¿å…é‡è¤‡æŠ•ä¿)</p>
    <div class="check-btn-group">
        <button class="check-btn yes" onclick="finishCheck(true)">âœ… æ˜¯ï¼Œæˆ‘å¾ˆæ¸…æ¥š</button>
        <button class="check-btn no" onclick="finishCheck(false)">âŒ å¦ï¼Œä¸å¤ªç¢ºå®š</button>
    </div>
</div>

<div id="step-result" class="step">
    <div id="final-message">
        <h2>ğŸ”„ æ­£åœ¨åˆ†æ...</h2>
        <p>ç³»çµ±æ­£åœ¨é‹ç®—æ‚¨çš„é¢¨éšªæ¬Šé‡èˆ‡è³‡ç”¢åå¥½...</p>
    </div>
    <div id="analysis-content"></div>
</div>

</div>

<script>
// ğŸ”´ è¨­å®šå€ï¼šè«‹å¡«å…¥æ‚¨çš„ Google Apps Script ç¶²å€
const scriptURL = "https://script.google.com/macros/s/AKfycbwNNc9BZ0AJzTGGYK4cnqAsuA78FtWMuuVoJMmn4hZpOSWuVCy0N6eLyPk-h414ZkJD/exec";

// æ¬Šé‡æ ¸å¿ƒï¼šå‰3åæœ‰æ•ˆ (5, 3, 1)
const RANK_WEIGHTS = [5, 3, 1]; 

const TAG_MAP = {
  lump_sum: "ä¸€æ¬¡é‡‘ (é‡å¤§/ç™Œç—‡)",
  monthly_pay: "åˆ†æœŸé‡‘ (å¤±èƒ½/é•·ç…§)",
  medical: "å¯¦æ”¯å¯¦ä»˜ (é†«ç™‚/æ‰‹è¡“)",
  accident: "æ„å¤–é¢¨éšª (è»Šç¦/éª¨æŠ˜)",
  savings: "è³‡ç”¢ç´¯ç© (å„²è“„/å‚³æ‰¿)"
};

/* ===== é¡Œåº«å€ (Ben çš„æƒ…å¢ƒåŒ–æ–‡æ¡ˆ) ===== */
const questionsSelf=[{id:"A1",cat:"ã€ä¿éšœå•Ÿå‹•æ–¹å¼ã€‘",title:"ä½ å¸Œæœ›ä½ ç¹³å‡ºå»çš„ä¿è²»ï¼Œæœªä¾†ä»¥ä»€éº¼å½¢å¼å¹«åˆ°ä½ ï¼Ÿ",options:[{text:"ç”Ÿå¤§ç—…æ™‚ï¼Œä¸€æ¬¡çµ¦ä»˜ 100ï½200 è¬ï¼Œæˆ‘è‡ªå·±åˆ†é…",tag:"lump_sum"},{text:"ç„¡æ³•å·¥ä½œæ™‚ï¼Œæ¯æœˆå›ºå®šçµ¦ä»˜ 3ï½5 è¬ï¼Œåƒé ˜è–ªæ°´",tag:"monthly_pay"},{text:"ä½é™¢æ‰‹è¡“æ™‚ï¼Œè²»ç”¨å¯¦å ±å¯¦éŠ·ï¼ŒæŠŠå¸³å–®è§£æ±ºæ‰",tag:"medical"},{text:"ç™¼ç”Ÿæ„å¤–æ™‚ï¼Œé‡å°éª¨æŠ˜å—å‚·çµ¦äºˆè£œè²¼",tag:"accident"},{text:"æ»¿æœŸæˆ–é€€ä¼‘æ™‚ï¼Œé€™ç­†éŒ¢èƒ½é€£æœ¬å¸¶åˆ©å›ä¾†ç•¶ä½œè³‡ç”¢",tag:"savings"}]},{id:"A2",cat:"ã€é¢¨éšªæ„Ÿå—ã€‘",title:"å“ªä¸€ç¨®ç‹€æ³ç™¼ç”Ÿï¼Œæœƒè®“ä½ å¿ƒç†å£“åŠ›æœ€å¤§ï¼Ÿ",options:[{text:"ç¢ºè¨ºç•¶ä¸‹æ€¥éœ€ä¸€å¤§ç­†éŒ¢ï¼Œå­˜æ¬¾ç¬é–“æ­¸é›¶",tag:"lump_sum"},{text:"æ”¶å…¥ä¸­æ–·ï¼Œä½†ç”Ÿæ´»è²»å’Œè²¸æ¬¾é‚„åœ¨è·‘",tag:"monthly_pay"},{text:"ç‚ºäº†çœéŒ¢ï¼Œä¸æ•¢ç”¨æ¯”è¼ƒå¥½çš„è‡ªè²»æ²»ç™‚",tag:"medical"},{text:"å°æ„å¤–ä¸€ç›´ä¾†ï¼Œç´¯ç©æˆç„¡æ³•å·¥ä½œçš„è² æ“”",tag:"accident"},{text:"ä¸çŸ¥ä¸è¦ºæŠŠéŒ¢èŠ±å…‰ï¼Œé€€ä¼‘æˆ–è€å¹´æ™‚æ²’éŒ¢å¯ç”¨",tag:"savings"}]},{id:"A3",cat:"ã€è³‡é‡‘ç”¨é€”ã€‘",title:"é€™ç­†ç†è³ é‡‘(æˆ–è³‡é‡‘)ä¸‹ä¾†ï¼Œä½ æœ€ä¸»è¦æ˜¯æ‹¿ä¾†è§£æ±ºä»€éº¼ï¼Ÿ",options:[{text:"è§£æ±ºæ¨™é¶è—¥ç‰©è²»ï¼Œæˆ–ç”Ÿç—…æœŸé–“çš„é€±è½‰",tag:"lump_sum"},{text:"è§£æ±ºé•·æœŸçš„çœ‹è­·è²»ã€ç™‚é¤Šé™¢è²»ç”¨",tag:"monthly_pay"},{text:"è§£æ±ºä½é™¢æœŸé–“çš„ç—…æˆ¿è²»ã€æ‰‹è¡“é›œè²»",tag:"medical"},{text:"è§£æ±ºè·Œå€’ã€è»Šç¦å¾Œçš„å¾©å¥æˆ–è–ªæ°´æå¤±",tag:"accident"},{text:"è§£æ±ºã€Œæœªä¾†çš„éŒ¢ã€ï¼Œä¾‹å¦‚é€€ä¼‘é‡‘æˆ–å¼·è¿«å„²è“„",tag:"savings"}]},{id:"A4",cat:"ã€æ±ºç­–é¢¨æ ¼ã€‘",title:"ä½ æ¯”è¼ƒèƒ½æ¥å—å“ªä¸€ç¨®è¦åŠƒæ–¹å¼ï¼Ÿ",options:[{text:"å½ˆæ€§æœ€é«˜ï¼ŒéŒ¢æ‹¿åœ¨æ‰‹è£¡æˆ‘è‡ªå·±æ±ºå®š",tag:"lump_sum"},{text:"è¦å‰‡æ¸…æ¥šï¼Œæ¯æœˆéƒ½æœ‰ç¾é‡‘æµæ”¯æŒ",tag:"monthly_pay"},{text:"åŠŸèƒ½å°å‘ï¼Œç™¼ç”Ÿå°±ç›´æ¥è™•ç†ï¼Œä¸æƒ³ç…©æƒ±",tag:"medical"},{text:"åˆ†æ•£é¢¨éšªï¼Œä¸è®“å–®ä¸€çªç™¼äº‹ä»¶å½±éŸ¿ç”Ÿæ´»",tag:"accident"},{text:"ä¿æœ¬ç©©å®šï¼Œæˆ‘å¸Œæœ›éŒ¢ä¸€å®šè¦ç•™ä¸‹ä¾†æˆ–è®Šå¤š",tag:"savings"}]},{id:"A5",cat:"ã€å„ªå…ˆé †åºã€‘",title:"å¦‚æœè¦ä½ å…ˆåšä¸€é …æº–å‚™ï¼Œä½ æœƒå„ªå…ˆé¸ï¼Ÿ",options:[{text:"é‡å¤§å‚·ç—…éšª (è§£æ±ºç•¶ä¸‹æ€¥ç”¨)",tag:"lump_sum"},{text:"å¤±èƒ½/é•·ç…§éšª (è§£æ±ºé•·æœŸç”Ÿæ´»)",tag:"monthly_pay"},{text:"å¯¦æ”¯å¯¦ä»˜é†«ç™‚ (è§£æ±ºé†«é™¢å¸³å–®)",tag:"medical"},{text:"æ„å¤–éšª (è§£æ±ºçªç™¼äº‹æ•…)",tag:"accident"},{text:"è³‡ç”¢ç´¯ç© (é€€ä¼‘/å‚³æ‰¿/å¼·è¿«å„²è“„)",tag:"savings"}]}];
const questionsFamily=[{id:"B1",cat:"ã€ä¿éšœå•Ÿå‹•æ–¹å¼ã€‘",title:"å¹«å®¶äººè¦åŠƒæ™‚ï¼Œæ€æ¨£çš„çµæœæœ€èƒ½è®“ä½ å®‰å¿ƒï¼Ÿ",options:[{text:"çµ¦æˆ‘å€‘ä¸€æ•´ç­†éŒ¢ï¼Œè®“æˆ‘å€‘æ±ºå®šæ€éº¼æ•‘",tag:"lump_sum"},{text:"æ¯å€‹æœˆçµ¦ä»˜ï¼Œè£œè²¼ç…§è­·è²» (æˆ–è¾­è·ç…§é¡§çš„è–ªæ°´)",tag:"monthly_pay"},{text:"å¹«å¿™æŠŠé†«é™¢çš„æ”¶æ“šä»˜æ‰ï¼Œä¸ç”¨å‹•åˆ°å­˜æ¬¾",tag:"medical"},{text:"é‡å°æ„å¤–å—å‚·çµ¦äºˆè£œè²¼ï¼Œæ¸›è¼•é¡å¤–é–‹éŠ·",tag:"accident"},{text:"ç„¡è«–æœ‰æ²’æœ‰ç”Ÿç—…ï¼Œé€™ç­†éŒ¢éƒ½èƒ½ç•™çµ¦å­©å­æˆ–å®¶äºº",tag:"savings"}]},{id:"B2",cat:"ã€é¢¨éšªæ„Ÿå—ã€‘",title:"å¦‚æœäº‹æƒ…ç™¼ç”Ÿï¼Œå“ªç¨®ç‹€æ³å°å®¶åº­å½±éŸ¿æœ€å¤§ï¼Ÿ",options:[{text:"çªç„¶è¦æ‹¿å‡ºå¹¾åè¬ã€ä¸Šç™¾è¬çš„æ²»ç™‚è²»",tag:"lump_sum"},{text:"æ¯å€‹æœˆå¥½å¹¾è¬çš„é–‹éŠ·ï¼Œä¸”ä¸çŸ¥é“è¦ä»˜å¤šä¹…",tag:"monthly_pay"},{text:"é »ç¹é€²å‡ºé†«é™¢çš„å„é …é›œæ”¯èˆ‡é–‹éŠ·",tag:"medical"},{text:"çªç™¼æ„å¤–å°è‡´çš„æ··äº‚èˆ‡é¡å¤–èŠ±è²»",tag:"accident"},{text:"æ²’æœ‰ç‚ºæœªä¾†å­˜ä¸‹è¶³å¤ çš„éŒ¢ï¼Œå°è‡´ç”Ÿæ´»å“è³ªä¸‹é™",tag:"savings"}]},{id:"B3",cat:"ã€ç…§é¡§è€…çš„ç—›é»ã€‘",title:"èº«ç‚ºå®¶äººçš„ä½ ï¼Œæœ€æ€•é‡åˆ°å“ªç¨®æƒ…æ³ï¼Ÿ",options:[{text:"å› ç‚ºæ²’éŒ¢ï¼Œè¢«è¿«æ”¾æ£„æŸäº›æ²»ç™‚æ©Ÿæœƒ",tag:"lump_sum"},{text:"éœ€è¦é•·æœŸå°ˆäººç…§é¡§ï¼Œæ‹–å®å…¨å®¶ç¶“æ¿Ÿ",tag:"monthly_pay"},{text:"ä½é™¢è²»ç”¨å¤ªé«˜ï¼ŒçŒ¶è±«è¦ä¸è¦ç”¨è‡ªè²»",tag:"medical"},{text:"ç™¼ç”Ÿæ„å¤–æªæ‰‹ä¸åŠï¼Œæ‰“äº‚ç”Ÿæ´»ç¯€å¥",tag:"accident"},{text:"è¾›è‹¦è³ºçš„éŒ¢éƒ½èŠ±æ‰ï¼Œæ²’æœ‰ç•™æ±è¥¿çµ¦ä¸‹ä¸€ä»£",tag:"savings"}]},{id:"B4",cat:"ã€æ±ºç­–é¢¨æ ¼ã€‘",title:"å¹«å®¶äººè²·ä¿éšªï¼Œä½ æœ€åœ¨ä¹çš„æ˜¯ï¼Ÿ",options:[{text:"è³‡é‡‘è¦éˆæ´»ï¼Œé‡åˆ°å¤§ç—…æˆ‘æœ‰è³‡æºèª¿åº¦",tag:"lump_sum"},{text:"ç¾é‡‘æµè¦ç©©ï¼Œä¸è¦è®“æˆ‘æ¯å€‹æœˆç…©æƒ±éŒ¢",tag:"monthly_pay"},{text:"åŠŸèƒ½è¦å¯¦ç”¨ï¼Œè§£æ±ºæœ€å¸¸ç™¼ç”Ÿçš„é†«ç™‚å¸³å–®",tag:"medical"},{text:"ä¿è²»è¦ä¾¿å®œï¼Œå…ˆæ±‚æœ‰åŸºæœ¬çš„æ„å¤–é˜²è­·",tag:"accident"},{text:"éŒ¢è¦å®ˆä½ï¼Œå°ˆæ¬¾å°ˆç”¨ï¼Œä¸è¢«è¼•æ˜“æŒªç”¨",tag:"savings"}]},{id:"B5",cat:"ã€æœ€å¾Œåº•ç·šã€‘",title:"ä½ æœ€æƒ³ç‚ºå®¶äººå®ˆä½çš„åº•ç·šæ˜¯ï¼Ÿ",options:[{text:"é‡åˆ°å¤§ç—…æ™‚æœ‰ã€Œæ•‘å‘½éŒ¢ã€ï¼Œä¸ç•™éºæ†¾",tag:"lump_sum"},{text:"ç„¡è«–å¦‚ä½•ï¼Œç”Ÿæ´»å“è³ªä¸èƒ½è¢«é•·æœŸæ‹–å®",tag:"monthly_pay"},{text:"è®“å®¶äººæœ‰æ¬Šåˆ©é¸æ“‡ã€Œæœ€å¥½çš„é†«ç™‚å“è³ªã€",tag:"medical"},{text:"è¬ä¸€ç™¼ç”Ÿæ„å¤–ï¼Œç”Ÿæ´»é‚„èƒ½æ­£å¸¸é‹ä½œ",tag:"accident"},{text:"ç¢ºä¿æœªä¾†æœ‰ä¸€ç­†ç¢ºå®šçš„è³‡é‡‘(æ•™è‚²/é€€ä¼‘/å‚³æ‰¿)",tag:"savings"}]}];

let currentMode="", currentQueue=[], answers=[], currentIndex=0, currentRank=[];
let familyWeight = 0.5;
let isSubmitting = false; // é˜²é€£é»æ——æ¨™

// ä»‹é¢é‚è¼¯ï¼šé¡¯ç¤ºæ»‘æ¡¿
function showSlider() {
    document.getElementById("btn-both").style.display = "none"; 
    document.getElementById("weight-slider-box").style.display = "block";
}

// æ ¸å¿ƒé‚è¼¯ï¼šé¸æ“‡æ¨¡å¼èˆ‡é©—è­‰
function selectTarget(mode){
  if(isSubmitting) return; 
  isSubmitting = true; 

  const name = document.getElementById("clientName").value.trim();
  const sex = [...document.getElementsByName("clientSex")].find(x=>x.checked)?.value;

  // ğŸ”¥ åš´æ ¼é©—è­‰ï¼šå§“åéçŸ­æˆ–æœªé¸æ€§åˆ¥æœƒè¢«æ“‹
  if(!name || name.length < 2 || !sex){
      alert("è«‹å¡«å¯«çœŸå¯¦å§“åä¸¦é¸æ“‡ç”Ÿç†æ€§åˆ¥ï¼Œä»¥ä¾¿é€²è¡Œæº–ç¢ºè²»ç‡åˆ†æï¼");
      isSubmitting = false;
      return;
  }
  
  // æ¬Šé‡è¨­å®š
  if (mode === 'both') {
      let sliderVal = document.getElementById('weightSlider').value;
      familyWeight = sliderVal / 100;
      let btn = document.getElementById("slider-confirm-btn");
      if(btn) btn.innerHTML = "è™•ç†ä¸­...";
  } else if (mode === 'self') { familyWeight = 0; } 
  else { familyWeight = 1; }

  // è½‰å ´å»¶é²
  setTimeout(() => {
      currentMode=mode;
      document.getElementById("weight-slider-box").style.display = "none";
      currentQueue=(mode==="family")?questionsFamily:questionsSelf;
      
      document.getElementById("step-intro").classList.remove("active");
      document.getElementById("step-question").classList.add("active");
      loadQuestion();
      isSubmitting = false;
  }, 300);
}

// è¼‰å…¥é¡Œç›®
function loadQuestion(){
  if(currentIndex>=currentQueue.length){handleQueueFinish();return;}
  currentRank=[];
  const q=currentQueue[currentIndex];
  document.getElementById("q-category").innerText=q.cat;
  document.getElementById("q-text").innerText=q.title;
  renderOptions();
}

// æ¸²æŸ“é¸é …
function renderOptions(){
  const q=currentQueue[currentIndex];
  const pool=document.getElementById("q-options");pool.innerHTML="";
  q.options.forEach((o,i)=>{
    const idx=currentRank.indexOf(i);
    const div=document.createElement("div");
    div.className="option-card"+(idx>-1?" selected":"");
    div.onclick=()=>toggleOption(i);
    div.innerHTML=`<div class="rank-box">${idx>-1?idx+1:""}</div><div class="option-text">${o.text}</div>`;
    pool.appendChild(div);
  });
  const btn=document.getElementById("next-btn");
  btn.classList.toggle("ready",currentRank.length===3);
  if(currentRank.length===3) btn.innerText = "ä¸‹ä¸€é¡Œ â”";
  else btn.innerText = `è«‹å†é¸ ${3-currentRank.length} å€‹`;
}

// é¸é …åˆ‡æ›é‚è¼¯
function toggleOption(i){
  const idx=currentRank.indexOf(i);
  if(idx>-1) { currentRank.splice(idx,1); } // å–æ¶ˆ
  else { if(currentRank.length < 3) currentRank.push(i); } // é¸æ“‡
  renderOptions();
}
function resetCurrentRank(){currentRank=[];renderOptions();}

function nextQuestion(){
  if(currentRank.length<3)return;
  const q=currentQueue[currentIndex];
  answers.push({
    mode:currentQueue===questionsSelf?"self":"family",
    title:q.title,
    rankedTags:currentRank.map(i=>q.options[i].tag)
  });
  currentIndex++;loadQuestion();
}

function handleQueueFinish(){
  if(currentMode==="both" && currentQueue===questionsSelf){
    alert("ç¬¬ä¸€éšæ®µå®Œæˆï¼æ¥ä¸‹ä¾†é€²å…¥å®¶äººè¦åŠƒéƒ¨åˆ†ã€‚");
    currentQueue=questionsFamily;currentIndex=0;loadQuestion();
  }else{
    document.getElementById("step-question").classList.remove("active");
    document.getElementById("step-check").classList.add("active");
  }
}

// ğŸ”¥ V14.0 çµç®—æ ¸å¿ƒ (å«ä¿è²»æ™ºæ…§æ¨ç®— & åå­—è»Ÿæ‹’çµ•)
function finishCheck(isKnown){
  document.getElementById("step-check").classList.remove("active");
  document.getElementById("step-result").classList.add("active");

  const name = document.getElementById("clientName").value.trim();
  const dob = document.getElementById("clientDob").value;
  const job = document.getElementById("clientJob").value;
  const contact = document.getElementById("clientContact").value;
  const sex = [...document.getElementsByName("clientSex")].find(x=>x.checked)?.value;

  // åå­—å“è³ªæª¢æ¸¬ (Soft Rejection)
  const junkPattern = /^[\u4e00-\u9fa5_a-zA-Z0-9 ]{2,20}$/;
  const isValidName = junkPattern.test(name) && !/æ¸¬è©¦|test|admin|123/.test(name.toLowerCase());

  // 1. åŸå§‹è¨ˆç®—
  let scores={self:{}, family:{}};
  ["lump_sum","monthly_pay","medical","accident","savings"].forEach(k=>{
      scores.self[k]=0; scores.family[k]=0;
  });

  let hasFirstPlaceSavings = false;

  answers.forEach(a=>a.rankedTags.forEach((t,i)=>{
      if(scores[a.mode][t] !== undefined) {
          scores[a.mode][t] += RANK_WEIGHTS[i];
      }
      if(t === 'savings' && i === 0) hasFirstPlaceSavings = true;
  }));

  // 2. åŠ æ¬Šè¨ˆç®—
  let wSelf = (currentMode === 'both') ? (1 - familyWeight) : 1;
  let wFamily = (currentMode === 'both') ? familyWeight : 1;
  if(currentMode === 'self') { wSelf = 1; wFamily = 0; }
  if(currentMode === 'family') { wSelf = 0; wFamily = 1; }

  const calcWeightedScore = (tag) => {
      return (scores.self[tag] * wSelf) + (scores.family[tag] * wFamily);
  };

  let totalLumpSum = calcWeightedScore("lump_sum");
  let totalMonthly = calcWeightedScore("monthly_pay");
  let totalSavings = calcWeightedScore("savings");
  let totalMedical = calcWeightedScore("medical");
  let totalAccident = calcWeightedScore("accident");

  let totalScore = totalLumpSum + totalMonthly + totalSavings + totalMedical + totalAccident;
  
  // 3. åˆ¤å®šé‚è¼¯
  let savingsRatio = totalScore > 0 ? (totalSavings / totalScore) : 0;
  const GAP_THRESHOLD = currentMode === 'both' ? 4 : 3; 
  let moneyDiff = Math.abs(totalLumpSum - totalMonthly);
  let riskDiff = Math.abs(totalMedical - totalAccident);

  // å‰å°é¡¯ç¤ºè®Šæ•¸ (æ¨¡ç³ŠåŒ–)
  let frontendTypeTitle = "";
  let frontendTypeClass = "";
  let frontendDesc = "";
  let frontendBadges = "";

  if (savingsRatio >= 0.3 && hasFirstPlaceSavings) {
      frontendTypeTitle = "ğŸŸª è³‡ç”¢ç´¯ç©å‹ (å°ˆæ¬¾å°ˆç”¨)"; 
      frontendTypeClass = "result-type-4";
      frontendDesc = "æ‚¨çš„é¸æ“‡é¡¯ç¤ºï¼Œæ‚¨éå¸¸é‡è¦–è³‡ç”¢çš„ã€Œç¢ºå®šæ€§ã€ã€‚ç›¸æ¯”æ–¼ç™¼ç”Ÿé¢¨éšªå¾Œçš„è£œå„Ÿï¼Œæ‚¨æ›´å‚¾å‘æ–¼ç¢ºä¿è³‡é‡‘èƒ½å¤ ç•™å­˜ä¸‹ä¾†ã€‚";
      frontendBadges += `<span class="tag-badge bg-purple">â˜… é‡è¦–ä¿æœ¬</span><span class="tag-badge bg-purple">â˜… å°ˆæ¬¾å°ˆç”¨</span>`;
  } else {
      if(moneyDiff <= GAP_THRESHOLD) { 
          frontendTypeTitle = "ğŸŸ© å…¨æ–¹ä½è€ƒé‡å‹ (å‡è¡¡æ¢ç´¢)"; 
          frontendTypeClass = "result-type-2";
          frontendDesc = "æ­å–œï¼æ‚¨å…·å‚™éå¸¸å…¨é¢çš„é¢¨éšªæ„è­˜ã€‚æ•¸æ“šé¡¯ç¤ºæ‚¨å°ã€Œè³‡é‡‘éˆæ´»åº¦ã€èˆ‡ã€Œé•·æœŸç©©å®šæ€§ã€åŒæ¨£é‡è¦–ï¼Œä¸åå»¢ä»»ä½•ä¸€æ–¹ã€‚";
          frontendBadges += `<span class="tag-badge bg-green">â˜… é—œæ³¨å…¨é¢</span><span class="tag-badge bg-green">â˜… å½ˆæ€§é…ç½®</span>`;
      } else if (totalLumpSum > totalMonthly) {
          frontendTypeTitle = "ğŸŸ¦ é«˜åº¦è‡ªç•™å‹ (è³‡é‡‘æŒæ§)"; 
          frontendTypeClass = "result-type-1";
          frontendDesc = "æ‚¨å‚¾å‘ã€ŒæŠŠé¸æ“‡æ¬Šç•™åœ¨è‡ªå·±æ‰‹ä¸Šã€ã€‚é‡åˆ°ç‹€æ³æ™‚ï¼Œæ‚¨å¸Œæœ›æ“æœ‰ä¸€ç­†å¤§é¡è³‡é‡‘ï¼Œèƒ½å¤ éˆæ´»èª¿åº¦èˆ‡é‹ç”¨ã€‚";
          frontendBadges += `<span class="tag-badge bg-blue">â˜… è³‡é‡‘éˆæ´»</span><span class="tag-badge bg-blue">â˜… ç•¶ä¸‹æ±ºç­–</span>`;
      } else {
          frontendTypeTitle = "ğŸŸ¨ åˆ†æ•£å®‰æ’å‹ (ç´°æ°´é•·æµ)"; 
          frontendTypeClass = "result-type-3";
          frontendDesc = "æ‚¨å‚¾å‘ã€Œå»ºç«‹ç©©å®šçš„ä¿è­·ç¶²ã€ã€‚æ¯”èµ·è‡¨æ™‚ç±ŒéŒ¢ï¼Œæ‚¨æ›´å¸Œæœ›æœ‰ç©©å®šçš„ç¾é‡‘æµæ”¯æŒï¼Œä¸è®“ç”Ÿæ´»ç¯€å¥è¢«æ‰“äº‚ã€‚";
          frontendBadges += `<span class="tag-badge bg-orange">â˜… é•·æœŸç©©å®š</span><span class="tag-badge bg-orange">â˜… é¢¨éšªåˆ†æ•£</span>`;
      }
  }

  if (riskDiff <= GAP_THRESHOLD) frontendBadges += `<span class="tag-badge bg-green">ğŸ›¡ï¸ å…¨éšªé˜²è­·</span>`;
  else if (totalMedical > totalAccident) frontendBadges += `<span class="tag-badge bg-blue">ğŸ¥ é‡è¦–é†«ç™‚å“è³ª</span>`;
  else frontendBadges += `<span class="tag-badge bg-orange">âš ï¸ é‡è¦–æ„å¤–é¢¨éšª</span>`;

  // 4. å¾Œå°æ•¸æ“šè‰™ (å«æ™ºæ…§ä¿è²»æ¨ç®—)
  function sort(o){return Object.entries(o).sort((a,b)=>b[1]-a[1]);}
  const sortedSelf=sort(scores.self);
  const sortedFamily=sort(scores.family);

  // ğŸ’° æ™ºæ…§ä¿è²»æ¨ç®—é‚è¼¯
  let incomeLevel = 2; // é è¨­ä¸­ç”¢ (å–®ä½: è¬/å¹´)
  if (job && job.match(/é†«|å¸«|é•·|ç†|ç¶“|è‘£|ç¸½/)) incomeLevel = 3; 
  if (job && job.match(/ç”Ÿ|ç®¡|åŠ©|å“¡|å·¥/)) incomeLevel = 1; 
  
  let willingnessMultiplier = 1.0;
  if (savingsRatio >= 0.3) willingnessMultiplier = 2.5; 
  else if (savingsRatio >= 0.15) willingnessMultiplier = 1.5; 
  else willingnessMultiplier = 0.8; 

  let basePremium = 3 * incomeLevel; 
  let safeLine = Math.round(basePremium * 0.5); 
  let standardLine = Math.round(basePremium * willingnessMultiplier); 
  let dreamLine = Math.round(basePremium * willingnessMultiplier * 1.8); 

  let report = `ã€ğŸ§‘ å®¢æˆ¶æª”æ¡ˆã€‘\nå§“åï¼š${name} (${sex})\nè·æ¥­ï¼š${job}\nä¿å–®å¥æª¢ï¼š${isKnown ? "æ¸…æ¥š" : "âš ï¸ ä¸æ¸…æ¥š"}\n`;
  if(currentMode==='both') report += `æ¬Šé‡è¨­å®šï¼šè‡ªå·± ${(1-familyWeight)*100}% / å®¶äºº ${familyWeight*100}%\n`;
  
  if(!isValidName) report += `âš ï¸ [ç³»çµ±æ¨™è¨˜] ç–‘ä¼¼ç„¡æ•ˆåå–®\n`;

  report += `------------------------\n`;
  
  // é¡§å•å°ˆç”¨æ•¸æ“š (åªæœ‰ä½ çœ‹å¾—åˆ°)
  report += `ã€ğŸ’° å»ºè­°é–‹å£å€é–“ (å¹´ç¹³åƒè€ƒ)ã€‘\n`;
  report += `ğŸ›¡ï¸ é˜²å®ˆç·šï¼š${safeLine} è¬\n`;
  report += `ğŸ¯ é€²æ”»ç·šï¼š${standardLine} è¬\n`;
  report += `ğŸš€ å¤©èŠ±æ¿ï¼š${dreamLine} è¬\n\n`;

  report += `ã€ğŸš€ é¡§å•å°ˆç”¨æ•¸æ“šè‰™ã€‘\n`;
  report += `ä¸»é¡å‹ï¼š${frontendTypeTitle}\n`;
  report += `å„²è“„ä½”æ¯”ï¼š${(savingsRatio*100).toFixed(1)}% (é–€æª»30%)\n`;
  report += `å„²è“„æ’ç¬¬ä¸€ï¼š${hasFirstPlaceSavings ? "âœ… æœ‰" : "âŒ ç„¡"}\n`;
  report += `ä¸€æ¬¡é‡‘ vs åˆ†æœŸé‡‘å·®è·ï¼š${moneyDiff.toFixed(1)} (é–€æª»${GAP_THRESHOLD})\n`;
  report += `åŠ æ¬Šç¸½åˆ†ï¼šå„²è“„${totalSavings.toFixed(1)} / ä¸€æ¬¡${totalLumpSum.toFixed(1)} / åˆ†æœŸ${totalMonthly.toFixed(1)} / é†«${totalMedical.toFixed(1)} / æ„${totalAccident.toFixed(1)}\n\n`;
  
  report += `ã€ğŸ“Š åŸå§‹æ¬Šé‡æ’åã€‘\n`;
  if(currentMode.includes("self")) report += `[è‡ªæˆ‘]\n` + sortedSelf.filter(s=>s[1]>0).map(s=>`${TAG_MAP[s[0]]}:${s[1]}`).join("\n") + "\n";
  if(currentMode.includes("family")) report += `[å®¶äºº]\n` + sortedFamily.filter(s=>s[1]>0).map(s=>`${TAG_MAP[s[0]]}:${s[1]}`).join("\n");

  // ç™¼é€
  fetch(scriptURL, {
    method: "POST", mode: "no-cors", headers: {"Content-Type": "text/plain"},
    body: JSON.stringify({ name: name, mode: currentMode, analysis: report })
  })
  .then(() => {
      document.getElementById("final-message").style.display = "none";
      let resultContainer = document.getElementById("analysis-content");
      
      let contactText = isValidName 
          ? "ç³»çµ±å·²å°‡æ‚¨çš„åå¥½æ¬Šé‡å‚³é€çµ¦é¡§å•ã€‚é¡§å•å°‡æ ¹æ“šæ‚¨çš„ã€Œè³‡ç”¢åå¥½ã€èˆ‡ã€Œé¢¨éšªå±¬æ€§ã€ï¼Œç‚ºæ‚¨è¦åŠƒæœ€é©åˆçš„æ–¹æ¡ˆã€‚"
          : "åˆ†æå·²å®Œæˆã€‚";

      let html = `
        <div style="text-align:center; margin-bottom:20px;">
            <h2 style="color: #27ae60; margin:0;">âœ… åˆ†æå®Œæˆ</h2>
            <p>æ„Ÿè¬æ‚¨çš„å¡«å¯«ï¼ä»¥ä¸‹æ˜¯æ‚¨çš„åˆ†æçµæœï¼š</p>
        </div>
        
        <div class="result-card ${frontendTypeClass}">
            <span class="result-title" style="color:var(--primary)">${frontendTypeTitle}</span>
            <div style="margin-bottom:15px;">${frontendBadges}</div>
            <div class="result-desc">${frontendDesc}</div>
            
            <div class="strategy-box">
               <b>ğŸ’¡ é¡§å•å»ºè­°ï¼š</b><br>
               ${contactText}
            </div>
        </div>
        
        <div class="disclaimer">
            æœ¬åˆ†æçµæœåƒ…ä¾›ä¿éšªéœ€æ±‚åå¥½åƒè€ƒï¼Œä¸ä»£è¡¨æ‚¨çš„ä¿éšœå·²è¶³å¤ æˆ–ä¸è¶³ã€‚<br>
            å¯¦éš›è¦åŠƒä»éœ€è€ƒé‡æ‚¨çš„å¹´é½¡ã€é ç®—åŠæ—¢æœ‰ä¿éšœå…§å®¹ã€‚
        </div>
      `;

      if(!isKnown && isValidName) {
          html += `
            <div style="background:#fff3cd;color:#856404;padding:15px;border-radius:8px;margin-top:20px;text-align:center;">
                <strong>ğŸ’¡ è²¼å¿ƒæé†’</strong><br>
                å»ºè­°é ç´„ä¿å–®å¥æª¢ï¼Œé¿å…é‡è¤‡æŠ•ä¿ï¼
            </div>
          `;
      }
      
      html += `<button class="nav-btn ready" onclick="location.reload()" style="margin-top:30px">é—œé–‰</button>`;
      
      resultContainer.innerHTML = html;
  })
  .catch(() => alert("å‚³é€å¤±æ•—"));
}
</script>
</body>
</html>
